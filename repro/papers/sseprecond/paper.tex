\title{Efficient Computation of Extended Sources}
\author{William. W. Symes \thanks{The Rice Inversion Project,
Department of Computational and Applied Mathematics, Rice University,
Houston TX 77251-1892 USA, email {\tt symes@caam.rice.edu}.}}

\lefthead{Symes}

\righthead{Approximate Source Inversion}

\maketitle
\begin{abstract}
Source extension is a reformulation of inverse problems in wave propagation, that at least in some cases leads to computationally tractable iterative solution methods. The core subproblem in all source extension methods is the solution of a linear inverse problem for a source (right hand side in a system of wave equations) through minimization of data error in the least squares sense with soft imposition of physical constraints on the source via an additive quadratic penalty. A variant of the time reversal method from photoacoustic tomography provides an approximate solution that can be used to precondition Krylov space iteration for rapid convergence to the solution of this subproblem. An acoustic 2D example for sources supported on a surface, with a soft contraint enforcing point support, illustrates the effectiveness of this preconditioner.
\end{abstract}

\section{Introduction}
Full Waveform Inversion (FWI) can be described in terms of 
\begin{enumerate}
\item a linear wave operator $L[{\bf c}]$, depending on a vector of
  space-dependent coefficients ${\bf c}$ and acting on causal vector wavefields $\bu$ vanishing in negative time:
\begin{equation}
\label{eqn:init}
\bu \equiv 0, t \ll 0; 
\end{equation}
\item a trace sampling operator $P$ acting on wavefields and producing data traces;
\item and a (vector) source function (of space and time) $\bff$ representing energy input to the system. 
\end{enumerate}
The basic FWI problem is: given data $d$, find ${\bf c}$ so that 
\begin{equation}
\label{eqn:fwi}
P\bu \approx d \mbox{ and } L[\bf{c}]\bu = \bff.
\end{equation}
In this formulation, the source function $\bff$ may be given, or
to be determined subject to some constraints.

%The energy source $\bff$ may also be largely undetermined, apart from some known characteristics such as localization in space and/or time. In fact, additional source degrees of freedom, beyond those needed to describe physically realized sources, may be useful in rendering the FWI problem \ref{eqn:fwi} more amenable to numerical solution, via so-called extended modeling (see \cite{geoprosp:2008}, \cite{LeeuwenHerrmannWRI:13}, \cite{HuangNammourSymesDollizal:SEG19}, and many references cited there). Therefore it is natural to view $\bff$ as also an unknown in formulating the problem \ref{eqn:fwi} via nonlinear least squares:
A simple nonlinear least squares formulation is:
\begin{equation}
\label{eqn:ols}
\mbox{choose } {\bf c} \mbox{ to minimize } \|PL[{\bf c}]^{-1}\bff -d \|^2.
\end{equation}
Practical optimization formulations typically augment the objective in
\ref{eqn:ols} by additive penalties or other constraints.

As is well-known, local optimization methods are the only feasible
approach given the dimensions of a typical instance of \ref{eqn:fwi},
and those have a tendency to stall due to ``cycle-skipping''. See for
exampe \cite{VirieuxOperto:09} and many references cited there. Source
extension is one approach to avoiding this problem. It consists in
imposing the wave equation as a soft as opposed to hard constraint, by
allowing the source field $\bff$ to have more degrees of freedom than
is permitted by a faithful model model of the seismic experiment, and
constraining these additional degrees of freedom by means of an
additive penalty modifying the probem \ref{eqn:ols}:
\begin{equation}
\label{eqn:esi}
\mbox{choose } {\bf c}, \bff \mbox{ to minimize } \|PL[{\bf c}]^{-1}\bff -d \|^2 + \alpha^2 \|A\bff\|^2 
\end{equation}
The operator $A$ penalizes deviation from known (or assumed)
characteristics of the source function - its null space consists of
feasible (or ``physical'') source models.

\cite{HuangNammourSymesDollizal:SEG19} present an overview of the
literature on source extension methods, describing a variety of
methods to add degrees of freedom to physical source model. The present paper
concerns {\em surface source extension}: physical sources are
presumed to be concentrated at points $\bx_s$ in space, whereas their extended
counterparts are permitted to spread energy over surfaces containing
the physical source locations. A simple choice for the penalty
operator $A$ is then multiplication by the distance $|\bx-\bx_s|$ to the physical
source location:
\begin{equation}
  \label{eqn:penop}
  (A\bff)(\bx,t) = |\bx-\bx_s|\bff(\bx,t)
\end{equation}
I shall use this choice of penalty operator whenever a specific choice
is necessary in the development of the theory below.

This paper presents a numerically efficient approach to solving the
{\em source subproblem} of problem \ref{eqn:esi}:
\begin{equation}
\label{eqn:esis}
\mbox{given } {\bf c}, \mbox{ choose } \bff \mbox{ to minimize }
\|PL[{\bf c}]^{-1}\bff -d \|^2 + \alpha \|A\bff\|^2 
\end{equation}
Solution of this subproblem is an essential component of {\em variable
  projection} algorithms for solution of the nonlinear inverse problem
\ref{eqn:esi}. Variable projection is not merely a convenient choice
of algorithm for this purpose: it is in some sense essential, see for
example \cite{Symes:SEG20}. It replaces the nonlinear
least squares problem \ref{eqn:esi} with a {\em reduced} problem, to
be solved iteratively. Each iteration involves solution of the
subproblem \ref{eqn:esis}. Therefore efficient solution of the
subproblem is essential to efficient solution of the nonlinear problem
via variable projection.

The penalty operator $A$ defined in \ref{eqn:penop} is linear, so the source
subproblem is a linear least squares problem. Under some additional
assumptions to be described below, I shall show how to construct an
accurate approximate solution operator for problem
\ref{eqn:esis}. This approximate solution operator may be used to
accelerate Krylov space methods for the solution of the source
subproblem \ref{eqn:esis}. Numerical examples suggest the
effectiveness of this acceleration.

I will fully describe the preconditioner construction for a special
case of the source subproblem \ref{eqn:esis}, in which ${\bf u}$ is an
acoustic field, $L[{\bf c}]$ is the wave operator of linear
acoustodynamics, the spatial positions of traces extracted by $P$ lie
on a plane, and the positions at which the extended
source $\bff$ is nonzero lie on another, parallel, plane. The data and
sources are further limited to pressure traces and constitutive law
defects (``pressure sources''). While this
``crosswell'' configuration simplifies the analysis underlying the
construction of approximate solutions for the source subproblem
\ref{eqn:esis}, it is only one of many transmission configurations for
which similar developments are possible. Perhaps the most important
alternative example is the diving wave configuration, which plays a
central role in contemporary FWI. I will discuss the generalization of
surface source extention to diving wave inversion at the end of the
paper.

The preconditioner construction is very similar to the time-reversal
method in photoacoustic tomography
\cite[]{StefanovUhlmannIP:09}. Preconditioning amounts to a change of
norm in the domain and range spaces of the modeling operator. In this
case, the modfied norms are weighted $L^2$, and the weight operators
map pressure to corresponding surface source on the source and
receiver planes. These are essentially the same as the ``hyperbolic
Dirichlet-to-Neumann'' map that plays a prominent role in
thermoacoustic tomography and other wave inverse problems
\cite[]{Rachele:00,StefUhl:05}. The obvious computation of these maps
- prescribe the pressure, solve the wave equation with this boundary
condition, read off the equivalent source - suffers from intrinsic
numerical inaccuracy. I suggest an alternative computationally
feasible approach.

\section{Operators}

For acoustic wave physics, the coefficient vector is
$\bf{c}=(\kappa,\rho)^T$, with components bulk modulus $\kappa$ and
density $\rho$, and the state vector $\bu=(p,\bv)^T$ consists of
pressure $p$ (a scalar space-time field) and particle velocity $\bv$
(a vector space-time field). The wave operator $L[\bf{c}]$ is:
\begin{equation}
\label{eqn:aweop}
L[\bf{c}]\bf{u} = 
\left(
\begin{array}{c}
\frac{1}{\kappa}\frac{\partial p}{\partial t}  + \nabla \cdot \bv, \\
\rho\frac{\partial \bv}{\partial t} + \nabla p.
\end{array}
\right) 
\end{equation}
That is,
\begin{equation}
  \label{eqn:awemat}
  L[{\bf c}] = \left(
    \begin{array}{cc}
      \frac{1}{\kappa}\frac{\partial}{\partial t} & \nabla \cdot \\
      \nabla & \rho \frac{\partial}{\partial t}
    \end{array}
  \right)
\end{equation}
$L[{\bf c}]$ has a well-defined inverse if it is restricted to either
causal or anti-causal vector wavefields.

Most of what follows is valid for any space dimension $n >0$. The
coefficient vector $\bf{c}=(\kappa,\rho)$ is defined throughout space
$\bR^n$, the state vector $\bu$ throughout space-time
$\bR^{n+1}$. Whenever convenient for mathematical manipulations,
$n=3$: for instance, I will write $\bx=(x,y,z)^T$ for the spatial
coordinate vector, and refer to the third (vertical) coordinate of
particle velocity as $v_z$. Examples
later in this paper will use $n=2$ for computational convenience.

Since all of the operators in the discussion that follows depend on
the coefficient vector 
$\bf{c}$, I will suppress it from the notation, for example, $L=L[\bf{c}]$.

The surface source extension replaces point sources on or near a
surface in $\bR^3$ with source functions confined to the same
surface. The simplest example of this extended geometry specifies a
plane $\{(x,y,z,t): z=z_s\}$ at source depth $z_s$ as the surface. For
acoustic modeling, surface sources are combinations of constitutive law
defects and loads normal to the surface, localized on $z=z_s$. That
is, right-hand sides in the system $L\bu=\bff$ take the form
$\bff(\bx,t) = (h_s(x,y,t)\delta(z-z_s),
f_s(x,y,t)\bf{e}_z\delta(z-z_s))^T$ for scalar defect $h_s$ and normal
force $f_s$ ($\bf{e}_z=(0,0,1)$). With the choice $L$ given in
\ref{eqn:awemat}, the causal/anti-causal wave system $L\bu^{\pm}=\bff$
takes the form
\begin{eqnarray}
\label{eqn:awepm}
\frac{1}{\kappa}\frac{\partial p^{\pm}}{\partial t} & = & - \nabla \cdot \bv^{\pm} +
h_s \delta(z-z_s), \nonumber \\
\rho\frac{\partial \bv^{\pm}}{\partial t} & = & - \nabla p^{\pm} +
                                                f_s{\bf e} \delta(z-z_s),\nonumber \\
p^{\pm} & =& 0 \mbox{ for } \pm t \ll 0,\nonumber\\ 
\bv^{\pm} & = & 0 \mbox{ for } \pm t \ll 0.
\end{eqnarray}

\noindent {\bf Remark:} In system \ref{eqn:awepm} and many similar
systems to follow, I will use the shorthand
\[
  p^+ = 0 \mbox{ for } t \ll 0 
\]
to mean that $p^+$ is {\em causal}, that is,
\[
  \mbox{For some } T \in \bR, p^+(\cdot,t) = 0 \mbox{ for all } t <
  T.
\]
Similarly,
\[
  p^- = 0 \mbox{ for } t \gg 0 
\]
signifies that $p^-$ is anti-causal.

Extended forward modeling consists in solving \ref{eqn:awepm} and
sampling the solution components at receiver locations. For
simplicity, throughout this paper I will assume that the receivers are
located on another spatial hyperplane $\{(x,y,z,t): z=z_r\}$ at
receiver depth $z_r>z_s$. The constructions to follow involve interchange
of the roles of $z_s$ and $z_r$ (that is, locating sources on $z=z_r$
and receivers at $z=z_s$), so rather than the sampling operator $P$ of
the introduction, I will denote by $P_s,P_r$ the sampling 
operators on $z=z_s$, $z=z_r$ respectively. In practice, sampling
occurs at a discrete array of points (trace locations) on these
surfaces, and over a zone of finite extent. In this theoretical
discussion, I will neglect both finite sample rate and extent, and
regard the data, for example $P_rp^+$, as continuously sampled and
extending over the entire plane $z=z_r$.

A technical difficulty with spatial sampling must be
addressed. Acoustic field energy is defined in terms of the mean
squares of the pressure and particle velocity fields. However fields
with finite mean square do not in general have well-defined
restrictions to lower-dimensional sets: for example, the pressure
field of a finite-energy acoustic vector field may not have a
well-defined restriction to the space-time plane $z=z_r$. This
phenomenon is related to the ill-posedness of wave equations as
evolution equations in spatial variables, an observation attributed to
Hadamard (see \cite{CourHil:62}, Chapter 6, section 17, also
\cite{Payn:75,Symes:83}). Some constraint on the acoustic field,
beyond finite energy, is mandatory in formulating the inverse problems
\ref{eqn:esi} and \ref{eqn:esis}. In fact, the natural constraint in
the ``crosswell'' geometry of this paper is that high-frequency energy
{\em not} travel along rays parallel or nearly parallel to the
surfaces $z=z_s, z=z_r$. I will call fields with this property {\em
  downgoing} (even though the concept also encompasses {\em upcoming}
fields). \cite{BaoSy:91b} give a mathematically complete discussion of
downgoing wave field properties.

For downgoing solutions of system \ref{eqn:awepm}, the key
components ($p^{\pm}$ and $v^{\pm}_z$) are continuous functions of $z$
in the open slab $z_s<z<z_r$ with well-defined limits at the boundary
planes, but may be discontinuous at the source plane
$z=z_s$. Similarly, the roles of $z_s$ and $z_r$ will be interchanged
in some of the constructions to come, and the corresponding solutions
may be discontinuous at $z=z_r$. Accordingly, interpret $P_s$, $P_r$
as the limit from right and left respectively: for $u=p^{\pm}$ or
$v^{\pm}_z$,
\begin{eqnarray}
  \label{eqn:defsamp}
  P_su(x,y,t) &=& \lim_{z \rightarrow z_s^+} u(x,y,z,t),\nonumber \\
  P_ru(x,y,t) &=& \lim_{z \rightarrow z_r^-} u(x,y,z,t).                  
\end{eqnarray}


The causal/anti-causal vector
modeling operators ${\cal S}^{\pm}_{z_s,z_r}$ are defined in terms of
the solutions $(p^{\pm},\bv^{\pm})$ of the systems \ref{eqn:awepm} by
\begin{equation}
  {\cal S}^{\pm}_{z_s,z_r}(h_s,f_s)^T  = (P_rp^{\pm},P_r v_z^{\pm})^T,
  \label{eqn:fwd}
\end{equation}
The subscript signifies that sources are located on $z=z_s$, the
receivers on $z=z_r$. It is necessary to include this information in
the notation, as versions of ${\cal S}^{\pm}$ with sources and receivers in
several locations will be needed in the discussion below.

\noindent {\bf Remark:} To connect with the formulation presented in
the introduction, note that for continuous $u$,
$P_su(x,y,t)=u(x,y,z_s,t)$, and therefore the adjoint of $P_s$ (in the
sense of distributions) is $P_s^Th(x,y,z,t) =
h(x,y,t)\delta(z-z_s)$. Write ${\cal P}_s = \mbox{diag }(P_s,P_s)$ and
similarly for ${\cal P}_r$. Then
\[
  {\cal S}^{+}_{z_s,z_r} = {\cal P}_r L^{-1}({\cal P}_s)^T,
\]
in which $L^{-1}$ is interpreted in the causal sense, and similarly
for ${\cal S}^{-}$. Sources confined to $z=z_s$ are precisely those
functions (distributions, really) output by ${\cal P}_s^T$, so the
problem statements \ref{eqn:esi} and \ref{eqn:esis} can be rewritten
in terms of ${\cal S}^+_{z_s,z_r}$, with $P$ identified with ${\cal P}_r$.

${\cal S}^{\pm}$ is not stably invertible (equation \ref{eqn:lamnull}). The
diagonal components of ${\cal S}^{\pm}$ thus carry essentially all of
its information, and it is in terms of these that a sensible inverse problem
is defined.

Denote by $\Pi_i, i=0,1$ the projection on the first,
respectively second, component of a vector in $\bR^2$. The 
forward modeling operator from pressure source to pressure trace is
\begin{equation}
  \label{eqn:sdef}
  S^{\pm}_{z_s,z_r} = \Pi_0 {\cal S}^{\pm}_{z_s,z_r} \Pi_0^T 
\end{equation}
and the forward modeling operator from velocity source (normal force)
to velocity trace is
\begin{equation}
  \label{eqn:vdef}
  V^{\pm}_{z_s,z_r} = \Pi_1 {\cal S}^{\pm}_{z_s,z_r} \Pi_1^T 
\end{equation}

With these conventions, we can write the version of the source
subproblem studied in this paper as
\begin{equation}
  \label{eqn:esisp}
  \mbox{find }h_s\mbox{ to minimize }\|S^{+}_{z_s,z_r}h_s- d\|^2 +
  \alpha^2\|Ah_s\|^2.
\end{equation}

\section{2D Examples}

\inputdir{project}

To illustrate the structure described in the preceding section, I
introduce two 2D acoustic models, one spatially homogeneous, the other
with highly refractive. The first, homogenous model has $\kappa = 4$
GPa and $\rho = 1$ g/cm$^3$ throughout a rectangular domain of size 8 km ($x$) $\times$ 4 km
($z$). The second, refractive, model is a perturbation of the first by
a low-velocity acoustic lens positioned in the center of the
rectangle. To produce this structure, the density is chosen
homogeneous as in the first model, while the bulk modulus decreases to
from 4 GPa outside the lens to 1.6 GPA in its center, as shown in Figure \ref{fig:bml0}.

Discretization is conventional, with a rectangular grid and staggered
finite difference scheme \cite[]{Vir:84} of order 2 in time and
2$k$ in space; for most of the experiments reported below, $k=4$.
Sampling operators such as $P_r$ are implemented via linear
interpolation, and source insertion via adjoint linear interpolation
(as noted above, in the continuum limit, sources are represented via
adjoint sampling). Steps in $x$ and $z$ are the same. Most results use
$\Delta x = 20$ m, and limit the temporal frequency of the computed
traces to 12.5 Hz. We also explore the dependence of a few results on frequency, using
$\Delta x = 10$ m and $5$ m, to accomodate 25 and 50 Hz respectively,
maintaining 8 samples per wavelength. All computations are carried out
in single precision.

\cite{GeoPros:11} gives a description of the code
implementation, out-of-date in a few respects but overall accurate.

The horizontal line of receivers sits at depth $z_r = $ 1000 m, as
shown in Figure \ref{fig:bml0}. Receiver $x$ ranges from $2000$ to
$6000$ m. A single point (physical) source appears in these
experiments, located at $x_s=3500$ m, $z_s=3000$ m, as also indicated
in the figure. The source time function is a bandpass filter with
corner frequencies $1, 2.5, 7.5, 12.5$ Hz for the lowest frequency
source, and scaled as appropriate for examples with higher frequency
and finer sampling.  Extended sources are confined to the horizontal
line through the physical source position, that is $z_s = 3000$ m,
over a 4 km interval starting at $x_r=$ 2000 m. Note that we have
reversed the order relation between $z_s$ and $z_r$ described in the
text ($z_s<z_r$). This difference is immaterial.

\plot{bml0}{width=\textwidth}{Bulk modulus, lens model. Color scale is
in GPa. Positions of point source and receiver line indicated.}

The point source pressure data generated by this configuration for the
homogeneous model is displayed in Figure \ref{fig:recphh0}, for the
lens model in \ref{fig:recplh0}. Triplication of arrivals is evident in the latter.

\plot{recphh0}{width=\textwidth}{Output pressure gather for point source in 
  homogeneous medium, configuration as described in Figure \ref{fig:bml0} and in
  the text.}

\plot{recplh0}{width=\textwidth}{Output pressure gather for point source in 
  refractive (lens) medium, configuration as described in Figure \ref{fig:bml0} and in
  the text.}

While inversion of pressure data is the main object of this exercise,
normal velocity ($v_z$) data will play an important role, so I display
the corresponding gathers in Figures \ref{fig:recvzhh0} and \ref{fig:recvzlh0}.

\plot{recvzhh0}{width=\textwidth}{Output vertical velocity gather for point source in 
  homogeneous medium, configuration as described in Figure \ref{fig:bml0} and in
  the text.}

\plot{recvzlh0}{width=\textwidth}{Output vertical velocity gather for point source in 
  refractive (lens) medium, configuration as described in Figure \ref{fig:bml0} and in
  the text.}

\section{Adjoints}

It follows from the adjoint state method (see Derivations section
below for details) that
\begin{equation}
  \label{eqn:sadj1}
  ({\cal S}^{\pm}_{z_s, z_r})^T = -{\cal S}^{\mp}_{z_r,z_s}
\end{equation}

Define $R$ to be the {\em time-reversal operator} on functions of
space-time, $Rf(\bx,t) = f(\bx,-t)$, and ${\cal R}$ to be the {\em
  acoustic field time-reversal operator}
\begin{equation}
  \label{eqn:trdef}
  {\cal R} \left(
    \begin{array}{c}
      p\\
      \bv
    \end{array}
  \right) =
  \left(
    \begin{array}{c}
      Rp\\
      -R\bv
    \end{array}
  \right)
\end{equation}
Then 
\begin{equation}
  \label{eqn:trsadj}
  {\cal R}{\cal S}^{\mp} = -{\cal S}^{\pm}_{z_r,z_s}{\cal R}
\end{equation}
Since $R^2 = I$ and ${\cal R}^2 = I$, the identities \ref{eqn:sadj} and \ref{eqn:trsadj} imply that

\begin{equation} 
  \label{eqn:trtr}
 ({\cal S}^{\pm}_{z_s,z_r})^T = {\cal R}{\cal S}_{z_r,z_s}^{\pm}{\cal R}=
 -{\cal S}^{\mp}_{z_r,z_s}.
\end{equation}

The relation \ref{eqn:trtr} implies that
\begin{eqnarray}
  (S^{\pm}_{z_s,z_r})^T &=& -S^{\mp}_{z_r,z_s} \nonumber\\
                        &=& R S^{\pm}_{z_r,z_s}R, \nonumber\\
    (V^{\pm}_{z_s,z_r})^T &=& -V^{\mp}_{z_r,z_s} \nonumber\\
                        &=& R V^{\pm}_{z_r,z_s}R.
                            \label{eqn:trtrcomp}
\end{eqnarray}

The implemented code uses the discrete adjoint state method and auto-generated code \cite[]{TapenadeRef13}, to
assure that the computed adjoint operators are adjoint at the level of
machine precision to the computed operators. The reverse-time storage
issue is resolved through the optimal checkpointing technique
\cite[]{Griewank:book,Symes:06a-pub}, again without loss of precision.

Typical results with pseudorandom input traces $d_r, h_z, w_r, f_s$ are:
\begin{itemize}
\item computed $\langle d_r, S^+_{z_s,z_r}h_s\rangle = -2.41069174,
  \langle (S^+_{z_s,z_r})^Td_r, h_s \rangle = -2.41069388.$
\item  computed $\langle w_r, V^+_{z_s,z_r}f_s\rangle = -2.73362470,
  \langle (V^+_{z_s,z_r})^Tw_r, f_s \rangle = -2.73362136.$
\end{itemize}
Ideally, the differences of these inner products should be at most a
relatively small multiple of machine precision, {\em relative} to the
products $\|d_r\|\| S^+_{z_s,z_r}\|\|h_s\|$ and
$\|w_r\|\|V^+_{z_s,z_r}\|\|f_s\|$ (division by these quantities makes the result
dimensionless and scale-independent). The operator norm $\| S^+_{z_s,z_r}\|$ is
computationally inaccessible, so instead I used the smaller quantities
$\|d_r\|\| S^+_{z_s,z_r}h_s\|$ etc. as stand-ins - thereby
overestimating the relative error between the inner products. In all
cases, over a very large number of random inputs, the largest observed
relative error estimate was $O(10^{-9})$, well under the appropriate limit for
single precision.

\section{Pressure-to-Source}

Since the system \ref{eqn:awepm} has a unique solution by standard
theory \cite[]{Lax:PDENotes}, the source vector field $(h_s,f_s)$
determines the acoustic field $(p^{\pm},\bv^{\pm})$ in space time, and
in particular the limits from the right at $z=z_s$, $P_sp^{\pm}$ and
$P_sv_z^{\pm}$. This relation is not invertible: it is not possible to
prescribe both pressure and normal velocity on a surface such as
$z=z_s$. So the columns of the matrix operator
${\cal S}^{\pm}_{z_s,z_r}$ must satisfy a linear relation. In this
section I will explain this relation; it involves the {\em
  pressure-to-source} map. This operator also turns out to be the
principle component of a preconditioning strategy for iterative
solution of the optimization problem \ref{eqn:esis}, so I will devote
some effort to its proper definition. It is closely related to the
Dirichlet-to-Neumann operator mentioned in the introduction.

While it is not possible to prescribe both pressure and velocity on
$z=z_s$ in solutions of \ref{eqn:awepm}, it is possible to
prescribe pressure only, for instance: if the function $\phi$ on
the surface $z=z_s$ satisfies suitable conditions, for
example the downgoing constraint mentioned earlier, a unique solution
exists for the acoustic system in both half-spaces $\pm z > z_s$:
\begin{eqnarray}
\label{eqn:awe0}
  \frac{1}{\kappa}\frac{\partial p_{\pm}}{\partial t} & = & - \nabla \cdot \bv_{\pm}, \nonumber \\
  \rho\frac{\partial \bv_{\pm}}{\partial t} & = & - \nabla
                                                    p_{\pm}, \nonumber \\
  p_{\pm} & =& 0,  \mbox{ for } t \ll 0, \nonumber\\ 
  \bv_{\pm} & = & 0 \mbox{ for } t \ll 0, \nonumber\\
  \lim_{z \rightarrow z_s^{\pm}}p_{\pm}(x,y,t,z)& =& \phi(x,y,t).
\end{eqnarray}
Note that the subscript $\pm$ here refers to the sign of $z-z_s$, as opposed
to the superscript ${\pm}$, which refers to the sign of $t$ throughout
this paper.

From the boundary condition (last equation in \ref{eqn:awe0}), one
sees that the pressures $p_{\pm}$ in the two half-spaces have the same
limit at the boundary $z=z_s$. Stick the two half-space
solutions together to form an acoustic field $(p^+,\bv^+)$ in all of
space-time, that is,
\begin{equation}
  \label{eqn:awealt}
  p^+(x,y,z,t) =
  \left\{
    \begin{array}{c}
      p_+(x,y,z,t) \mbox{ if } z>0,\\
      p_-(x,y,z,t) \mbox{ if } z<0,
    \end{array}
  \right.
\end{equation}
and a similar definition for $\bv^+$. Then $p^+$ is continuous across
$z=z_s$, and the boundary condition in system \ref{eqn:awe0} may be
written as $P_sp^+=\phi$.

The same construction can be carried out in the anti-causal sense,
with anti-causal half-space solutions glued together to form a
full-space distribution solution $(p^-,\bv^-)$, with the property that
$p^-$ is continuous across $z=z_s$ and $P_sp^-=\phi$.

The reader may object that the notation $(p^\pm,\bv^\pm)$ is already in
use, for the solution of \ref{eqn:awepm}. This objection is
valid. However, {\em in the sense
  of distributions}, $(p^{\pm},\bv^{\pm})$ as defined in display
\ref{eqn:awealt}, is {\em exactly} the causal solution of \ref{eqn:awepm}
for the choice $h_s = -[v^{\pm}_{z}]|_{z=z_s}, f_s=0$, as follows from a
simple integration-by-parts calculation. So the notation is consistent!

The negative jump $-[v^{\pm}_{z}]|_{z=z_s}$ is thus a function of $\phi$. Define
the {\em pressure-to-source} operator $\Lambda^{\pm}_{z_s}$ by
\begin{equation}
  \label{eqn:deflam}
  \Lambda^{\pm}_{z_s}\phi = -[v^{\pm}_{1,z}]|_{z=z_s}
\end{equation}
The conclusion: if $h_s = \Lambda^{\pm}_{z_s}\phi$ and $f_s=0$ in the
system \ref{eqn:awepm}, then $\phi=P_sp^{\pm}$.

Otherwise put, $S^{\pm}_{z_s,z_s}\Lambda^{\pm}_{z_s} \phi = \phi$, so
$\Lambda^{\pm}_{z_s}$ is inverse to $S^{\pm}_{z_s,z_s}$. The relation
\ref{eqn:trtrcomp} implies in turn that
\begin{equation}
  \label{eqn:lamadj}
  (\Lambda^{\pm}_{z_s})^T = - \Lambda^{\mp}_{z_s}
\end{equation}

There is also a {\em velocity-to-source} operator. For the solution
$(p^{\pm},\bv^{\pm})$ of system \ref{eqn:awepm} with $h_s=0$, the
normal component of velocity, $v^{\pm}_z$, is continuous across
$z=z_s$, and the velocity source (vertical load)
$f_s=-[p^{\pm}]_{z=z_s}$. I will not name the velocity-to-source
operator, as it does not appear explicitly in the developments to
follow. As will be seen, it is essentially the inverse of the
pressure-to-source operator.

The quadratic form defined by $\Lambda^{\pm}_{z_s}$ has fundamental
physical significance. Define the total acoustic energy $E^{\pm}(t)$ of the
field $(p^{\pm},\bv^{\pm})$, at time $t$ by
\begin{equation}
  \label{eqn:defae0}
  E^{\pm}(t) = \frac{1}{2} \int \,d\bx \, \left(\frac{(p^{\pm})^2}{\kappa} + \rho |\bv^{\pm}|^2\right)
\end{equation}
Then
\begin{equation}
  \label{eqn:elim}
  \pm \lim_{\pm t \rightarrow \infty} E^{\pm}(t) =  \langle P_sp^{\pm},
  (\Lambda^{\pm}_{z_s} P_sp^{\pm}) \rangle_{L^2(z=z_s)}.
\end{equation}
That is, the value of the quadratic form defined by
$\Lambda^{\pm}_{z_s}$, evaluated at the pressure trace on $z=z_s$,
gives the total energy transferred from the source to the
acoustic field over time. Since $E$ is itself a positive definite
quadratic form in the acoustic field, it follows that $\pm
\Lambda^{\pm}_{z_s}$ is positive semi-definite. 

While $\Lambda^{\pm}_{z_s}$ is positive semi-definite, it is not
symmetric. However, it is {\em approximately symmetric} in the
high-frequency sense. This fact follows from a
geometric optics analysis of the half-space solution,
assuming (as always) downgoing data:
\begin{equation}
  \label{eqn:lamappsim}
  (\Lambda^{\pm}_{z_s})^T \approx \Lambda^{\pm}_{z_s}.
\end{equation}

The analysis also reveals that the solution components not continuous
at $z=z_s$ are odd there:
\begin{equation}
  \label{eqn:odd1}
  \lim_{z\rightarrow z_s^+} v^{\pm}_{z} \approx - \lim_{z\rightarrow z_s^-}
  v^{\pm}_{z}
\end{equation}
for the solution of \ref{eqn:awepm} with $f_s=0$.
Similarly, 
\begin{equation}
  \label{eqn:odd2}
  \lim_{z\rightarrow z_s^+} p^{\pm}\approx - \lim_{z\rightarrow z_s^-}
  p^{\pm}
\end{equation}
for the solution of \ref{eqn:awepm} with $h_s=0$. Here ``$\approx$''
means in the sense of high frequency asymptotics, that is, that the
difference between the two sides is relatively smooth, hence small if
the data is highly oscillatory. Therefore if $f_s=0$ in system \ref{eqn:awepm},
\begin{equation}
  h_s = \Lambda^{\pm}_{z_s}P_sp^{\pm} = -[v^{\pm}_{z}]|_{z=z_s} \approx -2
  P_sv^{\pm}_{z}
  \label{eqn:tracejump10}
\end{equation}
Similarly, if $h_s=0$ in system \ref{eqn:awepm}, then
\begin{equation}
  \label{eqn:tracejump20}
  f_s = -[p^{\pm}]|_{z=z_s} \approx -2 P_s p^{\pm}.
\end{equation}
Thus $f_s$ determines approximately the boundary value of $p^{\pm}$,
as a solution of the acoustic wave system in the half-space
$z>z_s$. However, as repeated in equation \ref{eqn:tracejump10}, a
solution with this boundary value is also the restriction to $z>z_s$
of a solution to \ref{eqn:awepm} with $f_s=0$ and $h_s=
\Lambda^{\pm}_{z_s}P_sp^{\pm}$. Therefore if
\begin{equation}
  \label{eqn:hfcondn}
  h_s =\Lambda^{\pm}_{z_s}f_s,
\end{equation}
then the pressure boundary value $P_sp^{\pm}$ is the
same for the solutions of \ref{eqn:awepm} for source vectors $(h_s,0)$
and $(0,f_s)$. Since the pressure boundary values are the same, the solutions
in $z>z_s$ are the same. In particular, since $z_r>z_s$ and ${\cal
  S}^{\pm}_{z_s,z_r}(h_s,f_s)^T = (P_rp^{\pm},P_rv^{\pm}_z)^T$, it follows
that
\begin{equation}
  \label{eqn:snull}
  {\cal S}^{\pm}_{z_s,z_r}(-\Lambda^{\pm}_{z_s}f_s,f_s)^T \approx 0.
\end{equation}

Equation \ref{eqn:snull} states the relation between the columns of $
{\cal S}^{\pm}_{z_s,z_r}$ mentioned in the introduction to this
section.

To give an example of \ref{eqn:snull} in action, it is necessary to
create downgoing data and the action of the operator $\Lambda^{\pm}$
on a downdoing field data $f_s$ on $z=z_s$. Note that a point source
on $z=z_s$ creates high frequency energy traveling on rays parallel
and nearly parallel to $z=z_s$, so that won't do. One simple approach
is to create pressure and normal velocity data on $z=z_s$ by placing a
point source at a depth $z_d<z_s$. Since the examples used here are
homogeneous in $z<z_s$, the traces extracted from the resulting
causal pressure and velocity data on $z=z_s$ are {\em a priori}
downgoing, hence related by the operator $\Lambda^+_{z_s}$.

For a point source at $z_d=3500$ m, $x_d=3500$ m, same bandpass filter
wavelet as used for prior examples, causal data on $z=z_s=3000$ m are
shown in Figures \ref{fig:dsrcphh0} and \ref{fig:dsrcvzhh0}. Since the
mechanical parameters in the homogeneous and lens models are the same
for $z<z_s$, and no rays return to this zone in either model, these
data are asymptotically the same for both models, and I show only the
homogenous medium results. Regard these gathers as the trace
$(P_sp^+,P_sv^+_z)$ on $z=z_s$ of a downgoing acoustic field in $z>z_s$.
Equations \ref{eqn:tracejump10} and
\ref{eqn:tracejump20} show that these differ by a factor of -2 from
source functions $f_s$ and $h_s$ as in the system \ref{eqn:awepm},
with $h_s=0$ and $f_s=0$ respectively.

These source functions satisfy
the relation \ref{eqn:hfcondn}, therefore source vectors $(h_s,0)$ and
$(0, f_s)$ generate {\em the same acoustic field} $(p^+,\bv^+)$ in $z>z_s$. Figures
\ref{fig:drecphh0}, \ref{fig:dfwdphh0}, \ref{fig:daltphh0} (homogeneous model) and
\ref{fig:drecplh0}, \ref{fig:dfwdplh0}, \ref{fig:daltplh0} (lens model) show the pressure
gathers extracted at $z_r=1000$ m for the point source at $z=z_d$ and
for the two choices of extended source at $z=z_s$, on the same color
scale. The obvious similarity between the fields generated by the two
extended sources,
predicted by equation \ref{eqn:snull}, is confirmed by trace
comparisons in figures \ref{fig:drecphh0tr21}-\ref{fig:daltplh0tr81}.

\plot{dsrcphh0}{width=\textwidth}{Trace $P_sp^+$ on $z=z_s=3000$ m of
  pressure field from point source at $z_d=3500$ m, $x_d=3500$ m,
  bandpass filter source.}

\plot{dsrcvzhh0}{width=\textwidth}{Trace $P_sv_z^+$ on $z=z_s=3000$ m of
  vertical velocity field from point source at $z_d=3500$ m, $x_d=3500$ m,
  bandpass filter source.}

\plot{drecphh0}{width=\textwidth}{Pressure gather at receiver depth 
  $z_r=1000$ m from field generated by causal solution of acoustic 
  system \ref{eqn:awepm} in the homogeneous model described in the 
  text, with point pressure source (constitutive defect) at $z_d=3500$
  m, $x_d=3500$ m.}
  
\plot{dfwdphh0}{width=\textwidth}{Pressure gather at receiver depth 
  $z_r=1000$ m from field generated by causal solution of acoustic 
  system \ref{eqn:awepm} in the homogeneous model described in the 
  text, with extended pressure source (constitutive defect) on $z=z_s=3000$ m given by $-2$
  times the field depicted in Figure \ref{fig:dsrcvzhh0}
  ($h_s=-2P_sv_z^+$) and zero velocity source (vertical load) 
  ($f_s=0$).}

\plot{daltphh0}{width=\textwidth}{Pressure gather at receiver depth 
  $z_r=1000$ m from field generated by causal solution of acoustic 
  system \ref{eqn:awepm} in the homogeneous model described in the 
  text, with extended velocity source (vertical load) on $z=z_s=3000$ m given by $-2$
  times the field depicted in Figure \ref{fig:dsrcphh0}
  ($f_s=-2P_sp^+$) and zero pressure source (constitutive defect)
  ($h_s=0$).}

\plot{drecplh0}{width=\textwidth}{Pressure gather at receiver depth 
  $z_r=1000$ m from field generated by causal solution of acoustic 
  system \ref{eqn:awepm} in the lens model described in the 
  text, with point pressure source (constitutive defect) at $z_d=3500$
  m, $x_d=3500$ m.}
  
\plot{dfwdplh0}{width=\textwidth}{Pressure gather at receiver depth 
  $z_r=1000$ m from field generated by causal solution of acoustic 
  system \ref{eqn:awepm} in the lens model described in the 
  text, with extended pressure source (constitutive defect) on $z=z_s=3000$ m given by $-2$
  times the field depicted in Figure \ref{fig:dsrcvzhh0}
  ($h_s=-2P_sv_z^+$) and zero velocity source (vertical load) 
  ($f_s=0$).}

\plot{daltplh0}{width=\textwidth}{Pressure gather at receiver depth 
  $z_r=1000$ m from field generated by causal solution of acoustic 
  system \ref{eqn:awepm} in the lens model described in the 
  text, with extended velocity source (vertical load) on $z=z_s=3000$ m given by $-2$
  times the field depicted in Figure \ref{fig:dsrcphh0}
  ($f_s=-2P_sp^+$) and zero pressure source (constitutive defect)
  ($h_s=0$).}

\plot{drecphh0tr21}{width=\textwidth}{Overplot of traces 21 ($x=2400$)
  from gathers shown in \ref{fig:drecphh0} (blue), \ref{fig:dfwdphh0}
  (red).}

\plot{daltplh0tr81}{width=\textwidth}{Overplot of traces 81 ($x=3600$)
  from gathers shown in \ref{fig:drecplh0} (blue), \ref{fig:daltplh0}
  (red).}

\section{Approximate Inversion}

Computation of $\Lambda^{\pm}_{z_s}$ will prove a critical step in an
efficient iterative solution of the linear subproblem
\ref{eqn:esis}. Direct computation, for instance by solving
\ref{eqn:sawe2} and reading off $P_sv^{\pm}_{2,z}$, turns out to be
numerically ill-behaved. The relation \ref{eqn:snull} provides and
alternative approach, {\em provided} that an accurate approximate
inverse to $S^+_{z_s,z_r}$ is available. For instance, the first row
of the vector equation \ref{eqn:snull} reads (slightly rearranged):
\[
\Pi_0{\cal S}^+_{z_s,z_r}\Pi_1 f_s \approx \Pi_0{\cal
  S}^+_{z_s,z_r}Pi_0\Lambda^+_{z_s}f_s
\]
\begin{equation}
  \label{eqn:lamidea}
  = S^++_{z_s,z_r}\Lambda^+_{z_s}f_s.
\end{equation}
An approximate inverse for $S^++_{z_s,z_r}$ would permit solution of
this equation for $\Lambda^+_{z_s}f_s$.

In this section I will explain how to build the approximate inverse.
The key ingredient in this {\em time reversal} construction is a
{\em local energy decay} assumption. Define the local energy in the
acoustic field $(p,\bv)$ at
time $t$ in a region $\Omega \subset \bR^3$ by limiting the integration
in the definition of total energy \ref{eqn:defae0} to $\Omega$:
\begin{equation}
  \label{eqn:defaeloc}
  E_{\Omega}[(p,\bv)](t) = \frac{1}{2} \int_{\Omega} \,d\bx \, \left(\frac{p(\bx,t)^2}{\kappa(\bx)} + \rho(\bx) |\bv(\bx,t)|^2\right)
\end{equation}
The necessary assumption is: local energy decay in the half-space
$\Omega = \{(x,y,z): z \le z_r\}$. The local energy in $\Omega$ of the
causal solution $(p^+,\bv^+)$ of system \ref{eqn:awepm} cannot decay,
since the source on $z=z_s<z_r$ radiates in both positive and negative
$z$ in forward time. That obstacle is resolved by a redefinition of
the ``downgoing'' concept. I will call  downgoing if there is a
source-free acoustic field $(\tilde{p}^+,\tilde{\bv}^+)$ in all of space-time for which
\begin{itemize}
\item[1. ] $p^+ \approx \tilde{p}^+, \bv^+ \approx \tilde{\bv}^+$ in
  the slab $\{(x,y,z,t): z_s \le z \le z_r\}$, and
\item[2. ] The energy in $(\tilde{p}^+,\tilde{\bv}^+)$ decays in
  forward time, in the half-space $\Omega$:  $E_{\Omega}[(\tilde{p}^+,\tilde{\bv}^+)](t) \rightarrow 0$
  as $t \rightarrow \infty$.
\end{itemize}
Conditions for local energy decay have been widely studied in various
settings, for instance obstacle scattering
\cite[]{MorawetzPhillipsLax:05}. \cite{Pauen2000NonTr-6079 gives a
comprehensive overview of this subject. For smooth (non-scattering)
acoustic parameters, as is assumed in this paper, the crux of the
matter is that rays carrying high-frequence energy exit the half-space
$\Omega$ in finite time. For the half-space
geometries considered here, local energy does not decay in general,
because of the existence of ``trapped'' rays traveling parallel to the
boundary and remaining interior to $\Omega$ for all time. If an
acoustic field is downgoing in the usual sense, that is, its
high-frequency energy is concentrated on rays that exit $\Omega$
within some common maxiumum time, then the results cited above show
that local energy in $\Omega$ decays (exponentially for $n=3$).

Starting from this observation, it is possible to show that if the
source vector $(h_s,f_s)^T$ has the property termed ``downgoing'' in
preceding sections, that is, emanates high-frequency energy only along
rays that leave $\Omega$ within a common maximum time, then the
solution $(p^+,\bv^+)$ of \ref{eqn:awepm} is downgoing in the sense
defined here. All of our numerical examples behave as one would expect
for downgoing fields.

An immediate consequence of the downgoing assumption stated above is that in the
slab $z_s<z<z_r$, the field $(p^+,\bv^+)$ approximates the solution of an
anti-causal evolution equation. For any choice of $T$, define
$(\tilde{p}^-,\tilde{\bv}^-)$ to be the solution in the half-space
$\Omega$ of
\begin{eqnarray}
\label{eqn:revawe}
  \frac{1}{\kappa}\frac{\partial \tilde{p}^-}{\partial t} & = & - \nabla \cdot \tilde{\bv}^-, \nonumber \\
  \rho\frac{\partial \tilde{\bv}^-}{\partial t} & = & - \nabla \tilde{p}^-,\nonumber \\
  \tilde{p}^- & =& 0,  \mbox{ for } t=T,\nonumber\\ 
  \tilde{\bv}^- & = & 0 \mbox{ for } t=T,\nonumber\\
  P_r\tilde{p}^- &=& P_rp^+ \mbox { for } t \le T . 
\end{eqnarray}
As will be shown later, under the downgoing assumption, $P_r p^+
\approx P_r \tilde{p}^+$.
Therefore $(\delta p,\delta \bv)=(\tilde{p}^+-\tilde{p}^-,\tilde{\bv}^+-\tilde{\bv}^-)$
differs negligibly from the solution of
\begin{eqnarray}
\label{eqn:deltaawe}
  \frac{1}{\kappa}\frac{\partial \delta p}{\partial t} & = & -
                                                               \nabla
                                                               \cdot
                                                               \delta \bv, \nonumber \\
  \rho\frac{\partial \delta \bv}{\partial t} & = & - \nabla \delta p,\nonumber \\
  \delta p & =& \tilde{p}^+,  \mbox{ for } t=T,\nonumber\\ 
  \delta \bv & = & \tilde{\bv}^+ \mbox{ for } t=T,\nonumber\\
  P_r\delta p & = & 0,
\end{eqnarray}
in $\Omega \times \bR$. Since
$E_{\Omega}[(\tilde{p}^+,\tilde{\bv}^+)](T) \rightarrow 0$ as $T
\rightarrow \infty$, the usual energy estimate implies that the energy $\delta
E$ in this field,
\[
  \delta E_{\Omega}(t) = \frac{1}{2} \int_{\Omega} \,d\bx \,
 \left(\frac{(\delta p)^2}{\kappa} + \rho |\delta \bv|^2\right)
\]
satisfies $\delta E_{\Omega}(t) \rightarrow 0$ as $T \rightarrow
\infty$. This decay does not generally imply that $P_s\delta p, P_s \delta \bv)
\rightarrow 0$ (for instance) as $T \rightarrow \infty$, since the trace operator
$P_s$ is not continuous, but it does so imply for purely downgoing
fields, as will be demonstrated later, so
\begin{equation}
  \label{eqn:approxinv0}
  \lim_{T \rightarrow \infty} P_s\tilde{v}_z^- \approx \lim_{z \rightarrow
    0^+}\tilde{v}_z^+ \approx \lim_{z \rightarrow 0^+}v^+_z
\end{equation}
  
Recall (equations \ref{eqn:deflam}, \ref{eqn:jump0}) that
\[
  \Lambda^+_{z_s} P_s p^+ \approx 2 \lim_{z \rightarrow z_s^+}v^+_z 
\]
and that with $h_s= \Lambda^+_{z_s}P_sp^+$,
\[
  S^+_{z_s,z_r}h_s = P_r p^+
\]
Together with the last two equations, the relation
\ref{eqn:approxinv0} implies that
\begin{equation}
  \label{eqn:approxinv1}
  S^+_{z_s,z_r}(2 P_s \tilde{v}_z^-) \approx P_rp^+.
\end{equation}
As shown in the last section, the solution of the system
\ref{eqn:revawe} differs negligibly from the anti-causal solution $(p^-_2,\bv^-_2)$
of the system \ref{eqn:sawe2} with (i) $z_s$ replaced by $z_r$, and
(ii) $\psi = [p^-_2]|_{z=z_r} = -2 \lim_{z \rightarrow z_r^-} p^-_2
\approx -2 P_rp^+$. Therefore (definitions \ref{eqn:sdef}, \ref{eqn:vdef})
\begin{equation}
  \label{eqn:approxinv2}
  P_s \tilde{v}_z^- \approx V^-_{z_r,z_s}(-2 P_rp^+).
\end{equation}
Taken together, relations \ref{eqn:approxinv1} and
\ref{eqn:approxinv2} yield the first equation in the first main result of this section:
\begin{eqnarray}
  \label{eqn:approxinv}
  V^-_{z_r,z_s} S^+_{z_s,z_r} & \approx & -\frac{1}{4}I, \nonumber\\
  S^-_{z_r,z_s} V^+_{z_s,z_r} & \approx & -\frac{1}{4}I, \nonumber\\
  V^+_{z_s,z_r} S^-_{z_r,z_s} & \approx & -\frac{1}{4}I, \nonumber\\
  S^+_{z_s,z_r} V^-_{z_r,z_s} & \approx & -\frac{1}{4}I.\\
\end{eqnarray}.
The second equation follows by an exactly analogous argument, and the
last two by time reversal and interchange of the roles of $z_s$ and
$z_r$.

Having identified approximate two-sided inverses for $S^{\pm},
V^{\pm}$, the approximate null space identity \ref{eqn:lamnull} leads
to a relation between $\Lambda^{\pm}$ and ${\cal S}^{\pm}$ that
provides the foundation for practical computations. Applying $\Pi_0$
to both sides of \ref{eqn:lamnull} gives
\[
 \Pi_0 {\cal S}^+_{z_s,z_r}\Pi_1^T \approx \Pi_0 {\cal S}^+_{z_s,z_r}\Pi_0^T
 \Lambda^+_{z_s} = S^+_{z_s,z_r} \Lambda^+_{z_s}.
\]
From the first approximate identity in \ref{eqn:approxinv},
\begin{equation}
  \label{eqn:lamident}
  V^{-}_{z_r,z_s}\Pi_0 {\cal S}^+_{z_s,z_r}\Pi_1^T \approx -\frac{1}{4}\Lambda^+_{z_s}.
\end{equation}
This identity is the second major result of this section: it shows how
to compute that action of $\Lambda^+_{z_s}$ by propagating the input
pressure trace, identified as a source for the velocity evolution,
forward in time from $z_s$ to $z_r$
reading off the pressure trace on $z=z_r$, identifying it once more as
a source for velocity, propagating it backwards in time from $z_r$ to
$z_s$, and finally reading off the velocity trace, interpreted as a
pressure evolution source on $z_s$. I will give a detailed description
of this computation in the section on numerical results.

The importance of this result lies in the failure of the obvious
method for computing the action of $\Lambda^{\pm}_{z_s}$, namely to
employ the pressure trace as a source in the velocity equation ($f_s$,
in the notation used above) at $z=z_s$, and read off the velocity
field also at $z=z_s$. This difficulty is related to the existence of
tangentially propagating waves and the lack of continuity of the trace
operator. The method implicit in equation \ref{eqn:lamident} avoids
this difficulty by propagating the fields a positive distance in $z$:
assuming as always that the causal fields are downgoing, this step
eliminates any tangentially propagating fields from consideration.

Computation of the transpose of $\Lambda^+$ (exact, not approximate in
the high frequency sense) will be important in the
construction of a preconditioner. The relation \ref{eqn:lamident} also
provides an computation for this operator. The idea is to treat the
left-hand side of equation \ref{eqn:lamident} as an approximation to
$\Lambda$, and compute its exact transposes via the adjoint state
method (equations \ref{eqn:trtr} \ref{eqn:trtrcomp}):
\begin{equation}
  \label{eqn:lamtransp}
   \Pi_1 {\cal S}^-_{z_r,z_s}\Pi_0^T V^{+}_{z_s,z_r} \approx -\frac{1}{4}(\Lambda^+_{z_s})^T.
\end{equation} 
The left-hand sides of \ref{eqn:lamident} and \ref{eqn:lamtransp} will
simply be substituted for $\Lambda$ and its transpose in the
preconditioner construction: preconditioners must be (precisely)
self-adjoint, but need only be approximated to perform well.


\section{Accelerated Iterative Inversion}

\section{Fields, Traces and Sources}
In this section, $(p^{\pm}_0,\bv^{\pm}_0)$ denotes an acoustic field,
continuous in the region $z_s \le z $, obeying the homogeneous wave
equation in the interior $z_s < z $:
\begin{eqnarray}
\label{eqn:awe1}
  \frac{1}{\kappa}\frac{\partial p^{\pm}_0}{\partial t} & = & - \nabla \cdot \bv^{\pm}_0, \nonumber \\
  \rho\frac{\partial \bv^{\pm}_0}{\partial t} & = & - \nabla
                                                    p^{\pm}_0, \nonumber \\
  p^{\pm}_0 & =& 0,  \mbox{ for } t \ll 0, \nonumber\\ 
  \bv^{\pm}_0 & = & 0 \mbox{ for } t \ll 0.
\end{eqnarray}
I will show how to view $(p^{\pm}_0,\bv^{\pm}_0)$ as the $z>z_s$ part
of a solution of the system \ref{eqn:awepm} in two different ways,
corresponding to two different extensions to the whole space. An
important relation between the components of the operator
${\cal S}^{\pm}_{z_s,z_r}$ follows (equation \ref{eqn:lamnull} below).

Given a function $\phi$ on $z=z_s$, define $(p^{\pm}_1,\bv^{\pm}_1)$
as the solution in the two half-spaces $z <z_s, z>z_s$ of
\begin{eqnarray}
\label{eqn:awe1}
  \frac{1}{\kappa}\frac{\partial p_1}{\partial t} & = & - \nabla \cdot \bv_1, \nonumber \\
  \rho\frac{\partial \bv_1}{\partial t} & = & - \nabla p_1,\nonumber \\
  p^{\pm}_1 & =& 0,  \mbox{ for } \pm t \ll 0,\nonumber\\ 
  \bv^{\pm}_1 & = & 0 \mbox{ for } \pm t \ll 0,\nonumber\\
  \lim_{z \rightarrow z_s} P_sp^{\pm}_1& =& \phi.
\end{eqnarray}
By construction, $p^{\pm}_1$ is continuous across $z=z_s$. The
discontinuity $[v^{\pm}_{1,z}]|_{z=z_s}$ is a linear function of
$\phi$. Define the {\em pressure-to-source map} $\Lambda^{\pm}_{z_s}$ by
\begin{equation}
  \label{eqn:deflam}
  \Lambda^{\pm}_{z_s}\phi = [v^{\pm}_{1,z}]|_{z=z_s}
\end{equation}
Then as a distribution on all of $\bR^4$, $(p^{\pm}_1,\bv^{\pm}_1)$ solves the
inhomogeneous system
\begin{eqnarray}
\label{eqn:sawe1}
  \frac{1}{\kappa}\frac{\partial p^{\pm}_1}{\partial t} & = &
                                                        (\Lambda^{\pm}_{z_s}\phi)\delta(z-z_s) - \nabla \cdot \bv^{\pm}_1, \nonumber \\
  \rho\frac{\partial \bv^{\pm}_1}{\partial t} & = & - \nabla p^{\pm}_1,\nonumber \\
  p^{\pm}_1 & =& 0,  \mbox{ for } \pm t \ll 0,\nonumber\\ 
  \bv^{\pm}_1 & = & 0 \mbox{ for } \pm t \ll 0.
\end{eqnarray}

This is precisely the causal option of system \ref{eqn:awepm} for
$f_s=0$ and $h_s=\Lambda^{\pm}_{z_s}\phi$. From \ref{eqn:awe1} and the definition
\ref{eqn:fwd},
\begin{equation}
  \label{eqn:lamfwd}
  \phi = S^{\pm}_{z_s,z_s}\Lambda^{\pm}_{z_s}\phi,
\end{equation}
that is,
\begin{equation}
  \label{eqn:lamfwd1}
  S^{\pm}_{z_s,z_s} = (\Lambda^{\pm}_{z_s})^{-1}.
\end{equation}

Similarly, suppose $\psi$ is a function on $z=z_s$, and that
$(p^{\pm}_2,\bv^{\pm}_2)$ solves
\begin{eqnarray}
\label{eqn:awe2}
  \frac{1}{\kappa}\frac{\partial p^{\pm}_2}{\partial t} & = & - \nabla \cdot \bv^{\pm}_2, \nonumber \\
  \rho\frac{\partial \bv^{\pm}_2}{\partial t} & = & - \nabla p^{\pm}_2,\nonumber \\
  p^{\pm}_2 & =& 0,  \mbox{ for } \pm t \ll 0,\nonumber\\ 
  \bv^{\pm}_2 & = & 0 \mbox{ for } \pm t \ll 0,\nonumber\\
  \lim_{z \rightarrow z_s} P_sv^{\pm}_{2,z} &=& \psi.
\end{eqnarray}
in the two half-spaces $z<z_s, z > z_s$. In this case, $v^{\pm}_{2,z}$
is continuous at $z=z_s$ by construction. Viewed as a
distribution on all of $\bR^4$, $(p^{\pm}_2,\bv^{\pm}_2)$ solve the
system \ref{eqn:awepm} with $h_s=0$, and the discontinuity in pressure
across $z=z_s$ as the inhomogeneous term in Newton's law:
\begin{eqnarray}
\label{eqn:sawe2}
  \frac{1}{\kappa}\frac{\partial p^{\pm}_2}{\partial t} & = &
                                                        - \nabla \cdot \bv^{\pm}_2, \nonumber \\
  \rho\frac{\partial \bv^{\pm}_2}{\partial t} & = & 
                                                    [p^{\pm}_2]|_{z=z_s}{\bf e_z}\delta(z-z_s) - \nabla p^{\pm}_2,\nonumber \\
  p^{\pm}_2 & =& 0,  \mbox{ for } \pm t \ll 0,\nonumber\\ 
  \bv^{\pm}_2 & = & 0 \mbox{ for } \pm t \ll 0.
\end{eqnarray}
This relation defines a map from the velocity boundary data $\psi$ to
the source in the velocity equation, having units of force/volume,
similar to $\Lambda^{\pm}_{z_s}$. As it's not needed in the sequel, I
won't name this map.

A closer relation between traces and sources follows from the
geometric optics analysis of the half-space solution, presented
below. I will show that, for propagating wave data,
\begin{equation}
  \label{eqn:odd1}
  \lim_{z\rightarrow z_s^+} v_{1,z} \approx - \lim_{z\rightarrow z_s^-}
  v_{1,z}
\end{equation}
Similarly,
\begin{equation}
  \label{eqn:odd2}
  \lim_{z\rightarrow z_s^+} p_{2} \approx - \lim_{z\rightarrow z_s^-}
  p_{2}
\end{equation}
for the velocity field solving \ref{eqn:awe1}, or equivalently
\ref{eqn:awe1}. Here ``$\approx$'' means in the sense of high
frequency asymptotics, that is, that the difference between the two
sides is relatively smooth, hence small if the data is highly
oscillatory. Similarly, for the pressure field solving \ref{eqn:awe2}
or \ref{eqn:sawe2}, the jump at $z=z_s$ is twice the limiting value
(trace) from above, up to a smooth error. Therefore
\begin{eqnarray}
  \Lambda^{\pm}_{z_s}\phi = [v^{\pm}_{1,z}]|_{z=z_s} &\approx& 2
                              \lim_{z\rightarrow z_s}v^{\pm}_{1,z},\\  \label{eqn:tracejump1}
  [p^{\pm}_2]|_{z=z_s} &\approx& 2 \lim_{z\rightarrow z_s^+}p^{\pm}_{2},\\  \label{eqn:tracejump2}
\end{eqnarray}

%%%%%%%%%%%%%%%%%%%
These apparently harmless relations have a profound consequence,
because of a final step: identify the boundary data $\phi$ and $\psi$,
so far arbitrary, as the traces of $p^{\pm}_0$ and $v^{\pm}_{0,z}$ on $z=z_s$,
that is, set
\begin{eqnarray}
  \phi & = & P_s p^{\pm}_0, \nonumber \\
  \psi & = & P_s v^{\pm}_{0,z}.
             \label{eqn:bv0}
\end{eqnarray}
Since the traces on $z=z_s$ of the pressure fields $p^{\pm}_0$ and $p^{\pm}_1$ are
the same, and both are pressure components of solutions of the same homogeneous
acoustic system in $z>z_s$, the standard energy identity implies that
$(p^{\pm}_0,\bv^{\pm}_0) = (p^{\pm}_1,\bv^{\pm}_1)$ in
$z > z_s$. Similarly, $P_sv^{\pm}_{0,z}$ and $P_sv^{\pm}_{2,z}$ are
the same, whence $(p^{\pm}_0,\bv^{\pm}_0) = (p^{\pm}_2,\bv^{\pm}_2)$ in
$z>z_s$.

Therefore the assumption \ref{eqn:bv0} implies that
\begin{equation}
  \label{eqn:jump0}
  \Lambda^{\pm}_{z_s}\phi = [v^{\pm}_{1,z}]_{z=z_s} \approx 2P_s v^{\pm}_{0,z}  = 2\psi,
\end{equation}
and
\begin{equation}
  \label{eqn:jump1}
[p_2^{\pm}]_{z=z_s} \approx  2P_s p^{\pm}_{0}= 2 \phi.           
\end{equation}
In the notation of the last section, set $2 \phi = 2P_sp^{\pm}_0= f_s,
2\psi = 2P_s v^{\pm}_{0,z}= h_s$. Then relation \ref{eqn:jump0}
implies that
\begin{equation}
  \label{eqn:lamfh}
  \Lambda^{\pm}_{z_s}f_s \approx h_s.
\end{equation}

From the definitions in the last section and the system \ref{eqn:sawe1},
\begin{equation}
  \label{eqn:pident0}
P_r p^{\pm}_0 = \Pi_0{\cal S}^{\pm}(h_s,0)^T = \Pi_0{\cal
  S}^{\pm}\Pi_0^Th_s,
\end{equation}
and
\begin{equation}
  \label{eqn:pident1}
P_r p^{\pm}_0 \approx \Pi_0{\cal S}^{\pm}_{z_s,z_r} (0,f_s)^T = \Pi_0{\cal
  S}^{\pm}_{z_s,z_r} \Pi_1^Tf_s,
\end{equation}
Similarly, from the relations above and \ref{eqn:sawe2},
\begin{equation}
  \label{eqn:vident0}
  P_r  v^{\pm}_{0,z}  \approx \Pi_1{\cal S}^{\pm}_{z_s,z_r}(h_s,0)^T  =
  \Pi_1{\cal S}^{\pm}_{z_s,z_r} \Pi_0^Th_s 
\end{equation}
and
\begin{equation}
  \label{eqn:vident1}
  P_r  v^{\pm}_{0,z}  = \Pi_1{\cal S}^{\pm}_{z_s,z_r}(0,f_s)^T  =
  \Pi_1{\cal S}^{\pm}_{z_s,z_r} \Pi_1^Tf_s 
\end{equation}
Together with \ref{eqn:lamfh}, these equations imply that
\begin{equation}
  \label{eqn:lamnull}
{\cal  S}_{z_s,z_r}^{\pm}\Pi_0^T\Lambda^{\pm}_{z_s} \approx {\cal S}^{\pm}_{z_s,z_r}\Pi_1^T.
\end{equation}
Consequently, ${\cal S}_{z_s,z_r}$ has an ``approximate null space'',
in the sense that its composition with the block operator
$(\Lambda^{\pm}_{z_s},-I)^T$ is asymptotically negligible.

\section{Parametrix via Time Reversal}


\section{Approximate Unitarity}
Recall that the fields $(p^{\pm},\bv^{\pm})$ in $z>z_s$ can be viewed
as either the solution of the system \ref{eqn:awepm} with pressure source $h_s=0$ and
a suitable choice of velocity source $f_s$, or of the same system with
suitable choice of $h_s$ and $f_s=0$, and that these choices are
related by equation \ref{eqn:lamfh}: $\Lambda^{\pm}f_s = h_s$. The
pressure traces at $z=z_r>z_s$ are the same: from the definitions
\ref{eqn:sdef}, \ref{eqn:vdef},
\begin{eqnarray}
  \label{eqn:sandv}
  S^{\pm}_{z_s,z_r}h_s& =& P_rp^{\pm},\nonumber \\
  V^{\pm}_{z_s,z_r}f_s &=& P_rv_z^{\pm}.
\end{eqnarray}
Applying the same reasoning to traces on $z=z_r$: create pressure and
velocity sources $h_r$ and $f_r$ at $z=z_r$ by odd extension of the
velocity, respectively pressure, fields, and using the jumps as source
coefficients. Then as before
$\Lambda^{\pm}_{z_r}f_r=h_r=-P_rv^{\pm}_z$ (the sign change is due to
$Lambda$ producing the jump, whereas $P_rv^{\pm}_z$ is the limit from
the left of the field $v^{\pm}_{1,z}$ of system \ref{eqn:awe1}), hence
$\Lambda^{\pm}_{z_r}P_rp^{\pm} = P_rv_z^{\pm}$. Combining this
observation with equations
\ref{eqn:lamfh}, \ref{eqn:sandv}, obtain (with roles of $z_s,z_r$ interchanged)
\[
V^{\pm}_{z_r,z_w}(-2P_rp^{\pm}) =
  \Lambda^{\pm}_{z_s}S^{\pm}_{z_r,z_s}(-2P_rv_z^{\pm})  =
  \Lambda^{\pm}_{z_s}S^{\pm}_{z_r,z_s}(-2\Lambda^{\pm}_{z_r}P_rp^{\pm})
\]
whence
\begin{equation}
  \label{eqn:preunit}
 V^{\pm}_{z_r,z_w}
 =\Lambda^{\pm}_{z_s}S^{\pm}_{z_r,z_s}\Lambda^{\pm}_{z_r}.
\end{equation}

In view of the relations \ref{eqn:trtrcomp}, equation
\ref{eqn:preunit} implies that
\[
  V^-_{z_r,z_s}=-(V^+_{z_s,z_r})^T = -\Lambda^{-}_{z_s}(S^+_{z_s,z_r})^T\Lambda^{-}_{z_r}.
\]
\[
  =-(\Lambda^{+}_{z_s})^T(S^+_{z_s,z_r})^T(\Lambda^{+}_{z_r})^T.
\]
Therefore the first equation in display \ref{eqn:approxinv} can be re-written
\[
  -4V^-_{z_r,z_s}S^+_{z_s,z_r} =
\]
\begin{equation}
  \label{eqn:baseunit}
 4 (\Lambda^{+}_{z_s})^T(S^+_{z_s,z_r})^T(\Lambda^{+}_{z_r})^T
  S^+_{z_s,z_r} \approx I
\end{equation}

\section{Derivations}
\subsection{Extension to whole space}
If $\phi$ is smooth and vanishes for large negative $t$, then
$(p_1,\bv_1)$ can be constructed by pasting together the smooth
solutions of the inhomogeneous Dirichlet problems in the half-spaces
$\pm z > z_s$. Construct these by extending $\phi$ smoothly to
$\pm z>z_s$, and solve systems similar to \ref{eqn:awe1} for the
difference with $(p_1,\bv_1)$ by quoting the main results from
\cite{BlazekStolkSymes:13}. Since the right hand side in this
difference system is smooth, and the system is causal, the solution is
smooth and vanishes on $z=z_s$. Adding back the extension of $\phi$
produces smooth solutions in $\pm z > z_s$; define $(p_1,\bv)_1$ to be
these smooth functions in $z \ne z_s$. Since the boundary values for
pressure are the same, $p_1$ extends continuously to $z=z_s$. 
The pressure boundary value $\phi$ uniquely determines the solutions
in the two half-spaces, by standard energy estimates,

\subsection{Adjoint Computation}
The adjoint of ${\cal S}^+_{z_s,z_r}$ can be computed by a variant of
the adjoint state method, in this case a by-product of the
conservation of energy. Suppose that $p^-,\bv^-$ solve \ref{eqn:awem}
with $(h_s,f_s\bf{e}_z)\delta(z-z_s)$ replaced by
$ (h_r,f_r\bf{e}_z) \delta(z-z_r)$. Then
\[
0 = 
\left(\int\, dx\,dy\,dz\, \frac{p^+ p^-}{\kappa} +  
\rho \bv^+ \cdot \bv^- \right)|_{t \rightarrow \infty}
-
\left(\int\, dx\,dy\,dz\, \frac{p^+ p^-}{\kappa} +  \rho \bv^+ \cdot \bv^- \right)|_{t \rightarrow -\infty}
\]
\[
= 
\int_{-\infty}^{\infty} \,dt\, \frac{d}{dt}\left(\int\, dx\,dy\,dz\, \frac{p^+ p^-}{\kappa} +  \rho \bv^+ \cdot \bv^- \right)
\]
\[
= 
\int_{-\infty}^{\infty} \,dt\, \left(\int\, dx\,dy\,dz\, \frac{1}{\kappa} \frac{\partial p^+}{\partial t} p^- +  p^+ \frac{1}{\kappa}\frac{\partial p^-}{\partial t} \right.
\]
\[
+
\left. \rho \frac{\partial \bv^+}{\partial t} \cdot \bv^- + \rho \bv^+ \cdot \frac{\partial \bv^-}{\partial t} \right)
\]
\[
= 
\int_{-\infty}^{\infty} \,dt\, \left(\int\, dx\,dy\,dz\, \left(- \nabla \cdot \bv^+ + 
 h_s \delta(z-z_s)\right) p^- + p^+ \left(- \nabla \cdot \bv^- + 
 h_r \delta(z-z_r)\right) \right.
\]
\[
+
\left.  (- \nabla p^++f_s\bf{e}_z) \cdot \bv^- + \bv^+ \cdot (-\nabla
  p^- + f_r \bf{e_z}) \right)
\]
\[
= 
\int_{-\infty}^{\infty}\,dt\, \left(\int\, dx\,dy\,dz\, \left(- \nabla \cdot \bv^+ + 
 h_s \delta(z-z_s)\right) p^- + p^+ \left(- \nabla \cdot \bv^- + 
 h_r \delta(z-z_r)\right) \right.
\]
\[
+
\left.  p^+ (\nabla \cdot \bv^-) + (\nabla \cdot \bv^+) p^- 
  +f_s \delta(z-z_s) v_z^- + v_z^+f_r \delta(z-z_r) \right)
\]
after integration by parts in the last two terms. Most of what is left cancels, leaving 
\[
0 = \int_{-\infty}^{\infty}\,dt\,dx\,dy\, (h_sP_sp^-+f_zP_sv_z^-) +
( h_rP_rp^++f_rP_rv_z^+) = \langle (h_s,f_s), {\cal S}^-(h_r,f_r) \rangle+ \langle (h_r,f_r), {\cal S}^+_{z_s,z_r}(h_s,f_s) \rangle
\]
whence
\begin{equation}
\label{eqn:sadj}
 ({\cal S}^+_{z_s,z_r})^T = -{\cal S}^{-}_{z_r,z_s}.
\end{equation}

The systems \ref{eqn:awep} and \ref{eqn:awem} differ only in the direction of time evolution (causal vs. anti-causal). Define $R$ to be the {\em time-reversal operator} on functions of space-time,
$Rf(\bx,t) = f(\bx,-t)$, and ${\cal R}$ to be the {\em acoustic field time-reversal operator} 
\begin{equation}
  \label{eqn:trdef}
  {\cal R} \left(
    \begin{array}{c}
      p\\
      \bv
    \end{array}
  \right) =
  \left(
    \begin{array}{c}
      Rp\\
      -R\bv
    \end{array}
  \right)
\end{equation}
Then ${\cal R}(p^-,\bv^-)$ solves \ref{eqn:awep} with
$(h_s\delta(z-z_s),f_s\bf{e_z}\delta(z-z_s))$ replaced by
$(-Rh_r\delta(z-z_r), Rf_r\bf{e_z}\delta(z-z_r))$. That is,
\begin{equation}
  \label{eqn:trsadj}
  {\cal R}{\cal S}^- = -{\cal S}^+_{z_r,z_s}{\cal R}
\end{equation}
Since $R^2 = I$ and ${\cal R}^2 = I$, the identities \ref{eqn:sadj} and \ref{eqn:trsadj} imply that

\section{Surface source-to-pressure operator}

A particular case of the relation \ref{eqn:trtr} is important in its own right, when $z_r=z_s$. Define surface source-to-pressure operator $\Lambda_{z_s}$ by
\begin{equation}
  \label{eqn:ntoddef}
  \Lambda^{\pm}_{z_s} = S^{\pm}_{z_s,z_s}.
\end{equation}
Then \ref{eqn:trtr} reads
\begin{equation}
  \label{eqn:ntodtr}
  (\Lambda^+_{z_s})^T = R\Lambda_{z_s}^+R = -\Lambda^-_{z_s}
\end{equation}
This operator is closely related to the operator mapping $\lim_{z\rightarrow z_s^{\pm}} \bv_z^+$ to $\lim_{z\rightarrow z_s^{\pm}}  p^+$, often called the {\em Neumann-to-Dirichlet} operator. The connection is explained below.

The quadratic form defined by $\Lambda^{\pm}_{z_s}$ has fundamental physical
significance. Define the total acoustic energy $E^{\pm}(t)$ of the field $(p^{\pm},\bv^{\pm})$, at time $t$ by
\begin{equation}
  \label{eqn:defae}
  E^{\pm}(t) = \frac{1}{2} \int \,d\bx \, \left(\frac{(p^{\pm})^2}{\kappa} + \rho |\bv^{\pm}|^2\right)
\end{equation}
Then for $t_{\min}<t_{\max}$,
\[
  E^{\pm}(t_{\rm max})-E^{\pm}(t_{\rm min}) = \int_{t_{\rm min}}^{t_{\rm max}} \frac{dE^{\pm}}{dt}
\]
\[
  = \int_{t_{\rm min}}^{t_{\rm max}} \int\,d\bx\, \left(p^{\pm} \frac{1}{\kappa}\frac{\partial p^{\pm}}{\partial t} + \bv^{\pm} \cdot \rho \frac{\partial \bv^{\pm}}{\partial t}\right)
\]
\[
  =\int_{t_{\rm min}}^{t_{\rm max}} \int\,d\bx\,\left(p^{\pm}(-\nabla \cdot \bv^{+} + h_s\delta(z-z_s)) + \bv^{\pm} \cdot \rho \frac{\partial \bv^{\pm}}{\partial t}\right)
\]
\[
=  \int_{t_{\rm min}}^{t_{\rm max}}\int\,d\bx\, \left(\left(\nabla p^{\pm}+\rho \frac{\partial \bv^{\pm}}{\partial t}\right) + p^{\pm}h_s\delta(z-z_s)\right)
\]
\begin{equation}
  \label{eqn:eident}
  =  \int_{t_{\rm min}}^{t_{\rm max}}\int\,dxdy h_s p^{\pm}|_{z=z_s} = \int_{t_{\min}}^{t_{\max}}\langle h_s(t), (\Lambda^{\pm}_{z_s} h_s)(t) \rangle_{L^2(\bR^2)}.
\end{equation}
That is, $\langle h_s(t), (\Lambda^{\pm}_{z_s} h_s)(t)
\rangle_{L^2(\bR^2)}$ is the rate of energy transfer from source to
the fluid at time $t$.

Assume that $h_s$ has compact support in time. Then $E^{\pm}
\rightarrow 0$ as $t \rightarrow \mp \infty$, and is eventually
constant as $t \rightarrow \pm \infty$. Then the energy identity
\ref{eqn:eident} implies that
\begin{equation}
  \label{eqn:etot}
  \pm \lim_{t \rightarrow \pm \infty} E^{\pm}(t) = \int \,dt\, \langle
  h_s(t), (\Lambda^{\pm}_{z_s} h_s)(t)\rangle_{L^2(\bR^2)} = \langle
  h_s,\Lambda^{\pm}_{z_s} h_s\rangle
\end{equation}
By virtue of identity \ref{eqn:ntodtr},
\[
  \lim_{t \rightarrow -\infty}E^{-}(t) =-\langle
  h_s,\Lambda^{-}_{z_s} h_s\rangle
\]
\[
  =  \langle  h_s,(\Lambda^{^+})^T_{z_s} h_s\rangle
\]
\[
  =  \langle  h_s,\Lambda^{^+}_{z_s} h_s\rangle
\]
so
\begin{equation}
  \label{eqn:surfenergy}
  = \lim_{t \rightarrow \infty}E^{+}(t)
\end{equation}
That is, the energy total energy transferred from the source to the
causal acoustic field as it evolves forward in time is the same as the
total energy transferred to the anti-causal acoustic field as it
evolves backwards in time.

Also onclude from identity \ref{eqn:etot} that the symmetric part of $\Lambda^+_{z_s}$ is positive semidefinite:
\begin{equation}
  \label{eqn:lamsd}
  \frac{1}{2}((\Lambda_{z_s}^+)^T + \Lambda^+_{z_s}) \ge 0.
\end{equation}

%Observe that the causal acoustic system \ref{eqn:awep} implies directly that
%\begin{equation}
%  \label{eqn:sourcevjump}
%  h_s= [v_z]|_{z=z_s}.
%\end{equation}

%######################################
\section{Propagating Waves}
Define $H$ to be the subspace $\{\bu \in (L^2(\bR^3))^4: \bu=0,z\ge
z_s\}$, by analogy with \cite{Lax:PDENotes}, p. 122.
%Note: must add microlocal $H^1$ constraint per
%\cite[]{BaoSy:91b} so that trace operator is well-defined - postpone
%this.

Given $u=(\bar{p}_0,\bar{\bv}_0) \in H$, extend in $t$ by solving the
acoustic initial value problem
\begin{eqnarray}
\label{eqn:awe0}
  \frac{1}{\kappa}\frac{\partial p_0}{\partial t} & = & - \nabla \cdot \bv_0, \nonumber \\
  \rho\frac{\partial \bv_0}{\partial t} & = & - \nabla p_0,\nonumber \\
  p_0 & =& \bar{p}_0, t=0,\nonumber\\ 
  \bv_0 & = & \bar{\bv}_0, t=0,\nonumber\\
\end{eqnarray}
Standard results on hyperbolic systems assure existence of a unique
square-integrable (weak) solution, which is smooth if $(p_0,\bv_0)$ is
smooth at $t=0$ \cite[]{CourHil:62,LaxPDENotes}.

Note that $(p_0,\bv_0)=0$ near $t=0$ in the half-space $z>z_s$.

For any suitable space-time function $u$, define
\begin{equation}
  \label{eqn:postrace}
  P^+_{z_s}u(x,y,t) =
  \left\{
    \begin{array}{c}
      u(x,y,z_s,t), t>0,\\
      0, t\le 0.
    \end{array}
  \right\}
\end{equation}
(Here, ``suitable'' means: the trace on $z=z_s$ makes sense. More on
this later.)


Since $p_0$ also solves the acoustic system \ref{eqn:awe1} in $z>z_s$
and has the same data at $t=0, z>z_s$ and trace on $z=z_s$, standard
uniqueness theorem shows that $(p_1,\bv_1) = (p_0, \bv_0)$ in $z>z_s$.



\section{Progressing Waves and Symbols}

The symbol $\sigma(L[c])$ of a matrix operator $L[c]$ is a complex scalar-valued matrix of the same size. In terms of its product with an arbitrary vector $\bu \in \bR^{d+1}$, it is
\[
  \sigma(L[c]) \bu = e^{-i(\omega t + \bk \cdot \bx)} (L[c]e^{i(\omega t + \bk \cdot \bx)}\bu).
\]
For $L[c]$ given by the definition \ref{eqn:awemat}, obtain
\begin{equation}
  \sigma(L[c])(t,\bx,\omega,\bk) = i\left(
    \begin{array}{cc}
      \frac{\omega}{\kappa(\bx)} & \bk^T \\
      \bk & \rho(\bx) \omega)
    \end{array}
  \right)
\end{equation}

The characteristic equation of $L[c]$ is $\det \sigma(L[c]) = 0$. The significance of the characteristic equation is its role in constraining the phase $\psi(\bx)$ in the progressing wave ansatz,
\begin{equation}
  \label{eqn:go}
  \bu(\bx,t) = e^{i\omega (t-\psi(\bx))} \ba (\bx).
\end{equation}
Applying $L[c]$ to this ansatz, obtain
\[
  L[c]\bu(\bx,t)=i \omega
  \left(
    \begin{array}{c}
      \frac{1}{\kappa}a_p -  \nabla \psi \cdot \ba_v \\
      -a_p \nabla \psi + \rho \ba_v
    \end{array}
  \right) + ...
\]
\[
  = i \omega \sigma(L[c])(t,\bx,1,- \nabla \psi(\bx))ba + ...
\]
where ``$...$'' denotes terms of lower order in $\omega$. Thus $\bu$ as defined in equation \ref{eqn:go} is a high-frequency asymptotic solution, $L[c]\bu \approx 0$, if
\begin{itemize}
\item
  \begin{equation}
    \label{eqn:eik}
    \det(\sigma(L[c])(t,\bx,1,-\nabla \psi(\bx))) = 0,
  \end{equation}
  (eikonal equation), and
\item
  $\ba$ is a null vector of $\sigma(L[c])(t,\bx,1,-\nabla \psi)$.
\end{itemize}
Explicitly, the eikonal equation reads
\[
  0 = \rho^2\left(\frac{\rho}{\kappa}-|\nabla \psi|^2\right),
\]
equivalent to the familar form
\begin{equation}
  \label{eqn:usualeik}
  c|\nabla \psi| = 1,
\end{equation}
in which $c = \rho/\kappa$ is the wave velocity. Solution via the method of characteristics gives
\[
  \psi(\bx(t)) = \psi(\bx(0)) + t
\]
for a ray $t \mapsto \bx(t)$ satisfying
\[
  \frac{d\bx}{dt}(t) = -c(\bx)^2\nabla \psi(\bx(t))
\]
Finally, $\ba$ is a null vector of $\sigma(L[c])(\cdot,\cdot,1,-\nabla \psi)$ iff
\begin{equation}
  \label{eqn:godton}
  \ba_v = \frac{a_p}{\rho}\nabla \psi
\end{equation}
The scalar $a_p$ evolves along the ray according to the transport equation, which I will not derive here; suffice it to say that $a_p(t) = a_p(0) \gamma(t)$, where $\gamma > 0$ is smooth and $\gamma(0)=1$.

Suppose that $\bx_0 = (x,y,z_s)^T$ and $(\xi_x,\xi_y) \in \bR^2$ satisfies $c(\bx_0)|(\xi_x,\xi_y)|<1$. Then there is a neighborhood $\Omega$ of $\bx_0$ and $\xi_z \in C^{\infty}(\Omega), \xi_z>0$, so that $\bxi^{\pm}(\bx)=(\xi_x,\xi_y,\pm \xi_z(\bx))$ satisfy $c(\bx)|\bxi^{\pm}(\bx)|=1$ for $\bx \in \Omega$.

A standard argument shows that there exists $\epsilon > 0$ for which a solution $\psi^{\pm}$ of the eikonal equation exists in $\Omega \cap \{\bx: |z-z_s|<\epsilon\}$ with
\begin{equation}
  \label{eqn:eikic}
  \psi^{\pm}(x,y,z_s,t) = t -x \xi_x - y \xi_y, \, \frac{\partial \psi}{\partial z}(x,y,z_s,t) = \pm \xi_z(x,y,z_s).
\end{equation}
Let $\chi \in C_0^{\infty}, \chi(\bx_0)=1$, and set $p_0^{\pm}(x,y,t) = \chi(x,y,z_s)e^{i\omega(t-x\xi_x - y\xi_y)}$. Define $p_{\rm go}^{\pm} \in C^{\infty}(\Omega \cap \{\bx: |z-z_s|<\epsilon\})$ by
\[
  p_{\rm go}^{\pm}(\bx,t) = a^{\pm}_p(\bx) e^{i\omega (t-\psi^{\pm}(\bx))}.
\]
where $a^{\pm}_p$ solves the transport equation with $a^{\pm}_p|_{z=z_s} = \chi$. Set
\[
  \bv^{\pm}_{\rm go}(\bx,t) = \frac{a^{\pm}_p(\bx)}{\rho(\bx)}\nabla \psi^{\pm}(\bx) e^{i\omega (t-\psi^{\pm}(\bx))}
\]
Then $\bu^{\pm}_{\rm go} = (p^{\pm}_{\rm go}, \bv^{\pm}_{\rm go})$ is an asymptotic solution of $L[c]\bu = 0$ with $p^{\pm}_{\rm go}|_{z=z_s} = \chi e^{i\omega(t-x\xi_x - y\xi_y)}$.

From equations \ref{eqn:godton} and \ref{eqn:eikic},
\[
  v_{z,{\rm go}}^{\pm}(x,y,z_s,t) = \pm \frac{\chi(x,y,t)}{\rho(x,y,z_s)}\xi_z  e^{i\omega(t-x\xi_x - y\xi_y)}
\]
\begin{equation}
  \label{eqn:asymdton}
= \pm \frac{\chi(x,y,t)}{\rho(x,y,z_s)c(x,y,z_s)}\sqrt{1-c(x,y,z_s)^2(\xi_x^2+\xi_y^2)}
\end{equation}

Integration over frequency produces a progressing wave traveling (at least near $z=z_s$) downwards, that is, increasing $z$ with increasing $t$, for the choice of sight $\pm = +$, and upwards, that is, decreasing $z$ with increasing $t$, for the other sign. Therefore a causal progressing wave with $p$ given on $z=z_s$ is obtained by synthesizing distorted plane waves as just described with $\pm = +$ in $z>z_s$, $\pm=-$ in $z<z_s$. From equation \ref{eqn:asymdton}, the normal components of $\bv$ have limits equal in magnitude but of opposite sign as $z\rightarrow 0^{\pm}$, up to a lower frequency error. That is, the jump in $\bv$ satisfies
\begin{equation}
  \label{eqn:asymjump}
  [v_z]\approx 2\lim_{z\rightarrow 0^+} v_{z}
\end{equation}
where $\approx$ denotes ``up to a low frequency error'', from here on.

This construction also implies an approximation of the source-to-pressure operator as a pseudodifferential operator. Choose a partition of unity in $z=z_s$, for which the support of every member is a domain $\Omega$ for which the construction above can be carried out: this implies that there be a uniform $\delta > 0$ so that
\begin{equation}
  \label{eqn:nongraze}
  1>\delta + c(x,y,z_s)\sqrt{\xi_x^2+\xi_y^2}
\end{equation}
for all $(x,y,t,1,\xi_x,\xi_y) \in WF(p_0)$. Denote by $\Gamma$ the subset of $(x,y,t,k_x,k_y,\omega) \in T^*(\bR^3)$ for which $x,y,\xi_{xy}=k_{xy}/\omega$ satisfy the inequality \ref{eqn:nongraze}.

Then near $z=z_s$, $p$ is approximately a sum of geometric optics solutions of the type displayed above, integrated over $\omega,k_x,k_y$, with $k_{x,y} = \omega \xi_{x,y}$.  Thus
\[
  p(x,y,z_s,t) \approx \frac{1}{2}\int_{\Gamma(x,y)} \,d\omega\,dk_x\,dk_y \hat{[v_z]}\rho(x,y,z_s)c(x,y,z_s)
\]
\[
   \times \left(1-c^2(x,y,z_s)\left(\left(\frac{k_x}{\omega}\right)^2 + \left(\frac{k_y}{\omega}\right) ^2\right)\right)^{-1/2}e^{\i(\omega t + k_x x+ k_y y)}
\]
Since $p$ is the pressure component of a solution of \ref{eqn:awep}, equation \ref{eqn:sourcevjump} implies that
\begin{equation}
  \label{eqn:psidodton}
  \Lambda^+_{z_s} h_s(x,y,t) \approx \frac{1}{2}\int_{\Gamma(x,y)} \,d\omega\,dk_x\,dk_y
  \lambda_s(x,y,t,k_x,k_y,\omega) \hat{h_s}(k_x,k_y,\omega) e^{\i(\omega t + k_x x+ k_y y)}
\end{equation}
with
\begin{equation}
  \label{eqn:symboldton}
  \lambda^+_{z_s}(x,y,t,k_x,k_y,\omega) =\frac{1}{2}\rho(x,y,z_s)c(x,y,z_s)\left(1-c^2(x,y,z_s)\left(\left(\frac{k_x}{\omega}\right)^2 + \left(\frac{k_y}{\omega}\right) ^2\right)\right)^{-1/2}
\end{equation}

Restricted to $\Gamma$, $\lambda^+_{z_s} \in S^0_{0,1}(\bR^2)$ is real-valued, hence defines an essentially symmetric operator. That is,
\begin{equation}
  \label{eqn:approxsymm}
  (\Lambda^+_{z_s})^T \approx \Lambda^{+}_{z_s}.
\end{equation}

Note that the defintion \ref{eqn:appinv} of $ (S^+_{z_s,z_r})^{\dagger} $ is that of
the transpose of $S^+_{z_s,z_r}$ in the sense of weighted norms, as
follows. Define trace spaces $W=L^2(\bR^2 \times [0,T])$, with inner product
\[
  \langle h_1,h_2\rangle_s = \langle
  h_1,\frac{1}{2}(\Lambda^+_{z_s}+(\Lambda^+_{z_s})^T)h_2\rangle
\]
and $D=L^2(\bR^2 \times [0,T])$ with inner product
\[
  \langle d_1,d_2\rangle_r = \langle
  d_1,\left(\frac{1}{2}(\Lambda^+_{z_s}+(\Lambda^+_{z_s})^T)\right)^{-1}d_2\rangle
\]
(These definitions must be supplemented with constraints on
out-of-aperture smoothness). Then the adjoint of $S^+_{z_s,z_r}: W
\rightarrow D$ is
\[
 \left(\frac{1}{2}
   (\Lambda^+_{z_s}+(\Lambda^+_{z_s})^T)\right)^{-1}(S^+_{z_s,z_r})^T
 \left(\frac{1}{2}(\Lambda^+_{z_r}+(\Lambda^+_{z_r})^T)\right)^{-1}
\]
 By virtue of the approximation \ref{eqn:approxsymm}, this is
\[
   \approx
   (\Lambda^{+}_{z_s})^{-1}(S^{+}_{z_r,z_s})^T((\Lambda^{+}_{z_r})^{-1})^T
   = (S^+_{z_s,z_r})^{\dagger}.
\]
which from the last section is approximately inverse to
$S^+_{z_s,z_r}$. That is, with the domain and range described above,
$S^+_{z_s,z_r}$ is approximately unitary.

\section{Efficient Preconditioned CG}

\cite{HouSymes:EAGE16} demonstrated a very similar preconditioner for Least Squares Migration, also for its subsurface offset extension \cite[]{HouSymes:16}, motivated by \cite{tenKroode:12}. These constructions all involve the Dirichlet-to-Neumann operator. This concept also turns up in hidden form in the work of Yu Zhang and collaborators on true amplitude migration \cite[]{YuZhang:14,TangXuZhang:13,XuWang:2012,XuZhangTang:11,Zhang:SEG09,Zhang YuSun:08,ZhangSunGray:07,ZhangBleistein:05,Bleisteinetal:05}. 

The discussion so far can be summarized as follows: an efficient pseudoinverse for $S[c]$ is the weighted adjoint operator
\begin{equation}
\label{eqn:wadj}
S[c]^{\dagger} = W[c]_m^{-1}S[c]^TW[c]_d,
\end{equation}
in which 
\begin{equation}
\label{eqn:weights}
W[c]_m = \kappa^{-1}\Lambda[c]^{-1}_s,\,\, W[c]_d = \kappa^{-1}\Lambda[c]_r
\end{equation}
Here ``$\kappa$'' means the operator ``multiply by $\kappa$''.

The statement that $S[c]^{\dagger}$ is the weighted adjoint of $S[c]$ means that $S[c]^{\dagger}$ {\em is} the adjoint of $S[c]$ with respect to weighted norms 
\begin{itemize}
\item on the source space ($h_s$): weight $W[c]_m$
\item on the data space ($d_r$): weight $W[c]_d$
\end{itemize}
Since $S[c]^{\dagger}S[c] \approx I$ in subspaces of the domain space, as shown above, $S[c]$ is approximately unitary in (subspaces of) the Hilbert spaces of source and data traces with norms defined by the weighting operators $W_m$ and $W_d$ respectively. Therefore a Krylov space method employing these norms will converge rapidly, at least for the well-determined components of the solution.

The most convenient arrangement the CG algorithm taking advantage of the structure \ref{eqn:wadj} is the {\em Preconditioned CG}. Since the coefficient array $c$ will remain unchanged during the iteration, write $S$ instead of $S[c]$, etc. 

Allowing that the fit error will be measured by the data space norm, the least squares problem to be solved is not just $Sh \approx d$, but a regularized version:
\begin{equation}
  \label{eqn:einv}
  \mbox{minimize}_h \|Sh-d\|^2_d + \alpha^2 \|Ah\|^2_m
\end{equation}

[The modified data space norm $\|d\|_d^2 = \langle d, W_d d\rangle$ has physical meaning: for acoustics, it is proportional to the power transmitted through the surface $z=z_r$.]

The minimizer of the objective defined in equation \ref{eqn:einv} solves the normal equation
\begin{equation}
  \label{eqn:norm}
  (S^{\dagger}S + \alpha^2 A^{\dagger}A)h = S^{\dagger}d 
\end{equation}

where the weighted adjoint $S^{\dagger}$ has already been defined in equation \ref{eqn:wadj}, and $A^{\dagger}$ is the adjoint of $A$ in the weighted model space norm defined by $W_m$, namely
\begin{equation}
  \label{eqn:aadj}
  A^{\dagger} = W_m^{-1}A W_m.
\end{equation}

Introducing these definitions in the normal equation \ref{eqn:norm},
\begin{equation}
  \label{eqn:norm1}
  W_m^{-1}(S^TW_dS + \alpha^2 A^TW_mA)h = W_m^{-1}S^TW_md 
\end{equation}
Since $W_m$ is self-adjoint and positive definite, the common factor on both sides of \ref{eqn:norm1} can be re-written as

write $S^*, A^*$ for the adjoints with the original (Euclidean) inner product in the domains but the weighted inner product in data space:
\begin{equation}
  \label{eqn:normpart}
  Nh = (S^*S + \alpha^2 A^*A)h = S^*d 
\end{equation}
using the ``partly weighted'' adjoints
\begin{eqnarray}
  \label{eqn:sadj}
  S^* &=& S^T W_d,\\
  A^* &=& A^T W_m.
\end{eqnarray}
The Preconditioned Conjugate Gradient (``PCG'') algorithm for solution of equation \ref{eqn:normpart} with preconditioner $W_m$ is usually written as Algorithm 1.

\begin{algorithm}[H]
\caption{Preconditioned Conjugate Gradient Algorithm, Standard Version}
\begin{algorithmic}[1]
\State Choose $h_0=0$ 
  \State $r_0 \gets S^*d$
  \State $p_0 \gets W_m^{-1}r_0$
  \State $g_0 \gets p_0$
  \State $q_0 \gets Np_0$
  \State $k \gets 0$
  \Repeat
  \State $\alpha_k \gets \frac{\langle g_k,r_k \rangle}{\langle p_k,q_k\rangle}$
  \State $h_{k+1} \gets h_k + \alpha_k p_k$
  \State $r_{k+1} \gets r_k - \alpha_kq_k$
  \State $g_{k+1} \gets W_m^{-1}r_{k+1}$
  \State $\beta_{k+1} \gets \frac{\langle g_{k+1},r_{k+1}\rangle}{\langle g_k,r_k\rangle}$
  \State $p_{k+1}\gets g_{k+1}+\beta_{k+1}p_k$
  \State $q_{k+1} \gets Np_{k+1}$
  \State $k \gets k+1$
  \Until{Error is sufficiently small, or max iteration count exceeded} 
\end{algorithmic}
\end{algorithm}

The operator whose eigenvalue spectrum determines the speed of convergence here is the preconditioned normal operator
\begin{equation}
  \label{eqn:pno}
  W_m^{-1}N = S^{\dagger}S +\alpha^2 A^{\dagger}A
\end{equation}
This isn't just an approximate identity on a subspace, as $S^{\dagger}S$ is. The addition of the penalty term affects the spectrum, pushing parts of it away from $1$. I have not yet analyzed this effect, however for the ``in-aperture'' part of the model space,
\[
  W_m^{-1}N \approx I +\alpha^2 W_m^{-1}A^TW_mA
\]
For small $\alpha$, this operator is a perturbation of the spectrum of the identity, so convergence should be rapid. 

In the preceding section, I showed that effective choices for the weight operators are $W_m = \Lambda_s^{-1}$ and $W_d = \Lambda_r$, which are resepctively the ``Neumann-to-Dirichlet'' operator mapping pressure to normal particle velocity on the source surface $\{z=z_s\}$, and the ``Dirichlet-to-Neumann'' operator mapping pressure to normal particle velocity on the receiver surface. Application of these operators are expensive and/or awkward, so should be avoided if at all possible. 

A very important point: the weighted ``partial'' adjoint $S^*=S^TW_d$ appears {\em only} in combination with $S$ in the algorithm listed above, {\em except} for the very first line. That is, one can calculate $W_dS$ followed by $S^T$, rather than $S$ followed by $S^TW_d$, provided that you can take care of the first line. $W_dS$ For any variant of elasticity, $W_d$ relates two combinations of dynamical field components - for acoustics, it returns the normal velocity for a given pressure field on the receiver surface. In the solution of the dynamical equations (for instance \ref{eqn:awe}), all components are calculated. Therefore obtaining the output of $W_d$ amounts to extracting the appropriate field combination. For acoustics, simply record the normal velocity rather than the pressure: then you have computed $W_dS$. Therefore no additional expensive computations are required. It is only the very first instance of $S^*$, on the first line, where an actual computation of $W_d$ is required, unless cheap workarounds like that explained by \cite{HouSymes:15} are available.

\section{Prototype Numerical Examples}
I present a collection of simple examples that illustrate the features of the surface source extension claimed in preceding sections. 

I used the IWAVE acoustic staggered grid package to carry out these calculations. This package implements (2,2k) schemes for k=1,2,..., and outputs traces (of either velocity or pressure at any point in space via multilinear interpolation. The discretized modeling operator is thus of second order accuracy, though as usual I have used higher order in space to reduce grid dispersion.

Source injection is implemented as the adjoint of trace sampling, resulting in another second-order error [REFERENCES]. 

The data is a single shot gather, with a source at coordinates $x_s=z_s=3000$ m (units of length are meters in all cases). The receiver line occupies $1500 \le x_r \le 5500$ m, with receiver depth $z_r=1000$ m.  Extended sources occupy $1500 \le x_s \le 5500$ m, with the same depth $z_s=3000$ m as the ``physical'' source used to generate the data. This region turns out to be adequate to represent the extended sources that approximately invert the data, for the cases examined below. An algorithm to automatically identify an appropriate region can be based on the ideas developed by \cite{Fu:Geo17}.

I have used absorbing boundary conditions (split-field PML) on all four sides of the 4000 m (vertical) $\times$ 8000 m (horizontal) simulation domain. Evidently inclusion of a free surface is important to the application of the ideas explained here to diving wave marine data, and I have not addressed the necessary modifications here. 

The Dirichlet-to-Neumann operator $\Lambda$ is an essential part of the inner problem preconditioner just presented. Implementation can be accomplished in several ways:
\begin{itemize}
\item \cite{tenKroode:12} suggests using a one-way operator;
\item if both pressure and normal partical velocity are measured (or simulated), then the two are related by $\Lambda$ and the velocity component can simply be used as the output;
\item presence of a free surface implies all of the usual problems, such as the need for removal of receiver-side ghosts. On the other hand, if the free surface is within a quarter-wavelength throughout the useful bandwidth of the data, then the ghosted data differs from $\Lambda p$ by a time integration and a scale factor, a fact used to good effect by \cite{HouSymes:15}.
\end{itemize}

In the examples, I have used the second observation. With a finite difference implementation of the pressure-velocity system \ref{eqn:awe}, velocity components are available ``for free'', short-circuiting explicit computation of $\Lambda$.

The  {\tt project/SConstruct} script is set up to carry out the necessary computations on grids with spacings $\Delta x = \Delta z = $ 20, 10, and 5 m, with a jump of roughly 8 in computation time resulting from each refinement. For present purposes, the coarsest (20 m) grid seems to be sufficient, and that is the grid used in the examples presented below. The source pulses are chosen so that the computation is reasonably accurate. For the 20 m grid case, I use a zero-phase trapezoidal bandpass filter source with corner frequencies of 1.0, 2.0, 7.5, and 12.5 Hz.

The IWAVE asg driver has been set up to recognize the case {\tt deriv=0} as defining the map from source (right-hand side in the pressure equation) to data (pressure) traces. The adjoint to this map, as explained above, is reverse-time propagation of the data traces as pressure sources, followed by scaling (formula \ref{eqn:sadj}). The approximate inverse is computed by application of the Dirichlet-to-Neumann operator to the pressure traces to produce corresponding velocity traces, followed by injection as pressure sources and reverse time propagation, followed by another application of the Dirichlet-to-Neumann map and scaling (formulas \ref{eqn:appinv}, \ref{eqn:adj}).

The script implements these operatations step-by-step via calls to IWAVE, Madagascar, and SU commands. A peculiarity of the {\tt asg.x} driver needs to be mentioned: it is based on an un-scaled version of the constitutive law defect source representation, that is, {\tt asg.x} approximately computes the solution of the system \ref{eqn:awedata} with the first equation replaced by
\begin{equation}
\label{eqn:asgdata}
\frac{\partial p}{\partial t}  =  - \kappa \nabla \cdot \bv +
h \delta(z-z_s).
\end{equation}
Denote by $S_{\rm asg}[c]$ the forward map produced by {\tt asg.x}. Then comparison of \ref{eqn:awedata} and \ref{eqn:asgdata} reveals that
\begin{equation}
\label{eqn:sreln}
S[c]=S_{\rm asg}[c]\kappa
\end{equation}
where $\kappa$ is shorthand for the operator of multiplication by $\kappa$. Accordingly, and approximate inverse for $S_{\rm asg}[c]$ is
\[
I \approx S_{\rm asg}[c]^{\dagger}S_{\rm asg}[c] = S_{\rm asg}[c]^{\dagger}S[c]\kappa^{-1}
\]
Since $S[c]S[c]^{\dagger} \approx I \approx S[c]^{\dagger}S[c]$, it follows that
\[
S_{\rm asg}[c]^{\dagger}=\kappa S[c]^{\dagger} = \kappa\Lambda[c]_s S[c]^T \Lambda[c]_r 
\]
\begin{equation}
\label{eqn:asginv}
= \kappa \Lambda[c]_s \kappa S_{\rm asg}[c]^T\Lambda[c]_r
\end{equation}
This is the approximate inverse computed in the examples. Note that
only the values of $\kappa$ near the source datum $z=z_s$ play a role
in the relation \ref{eqn:sreln} or in the definition \ref{eqn:asginv}
of the IWAVE ASG approximate inverse.

\section{Discussion}

The source subproblem is a necessary step in solving the overall FWI problem \ref{eqn:fwi}. In particular, the nonlinear least squares realization \ref{eqn:esi} of source-extended FWI is naturally approached via the {\em variable projection method} \cite[]{GolubPereyra:73,GolubPereyra:03,vanLeeuwenMulder:09,Rickett:SEG12}, in which the minimum over $\bff$ in \ref{eqn:esis} is treated as a function of $\bf{c}$, which is in turn minimized. Variable projection thus treats the source subproblem as an inner problem, which must be solved for an estimate of $\bff$ at every step of an iterative method for the outer problem of minimization over $\bf{c}$. Efficiency in solving the source subproblem \ref{eqn:esis} is critical to efficient implementation of variable projection for solving the regularized FWI problem \ref{eqn:esi}.

This paper restricts the choice of wave physics embodied in
$L[\bf{c}]$ to linear acoustics.  Thus $\bf{c}=(\kappa,\rho)$ is the
pair (bulk modulus, density) of positive functions of spatial
position. The principal characteristics assumed of sources $\bff=$ are localization and isotropy. That is, physical sources will be assumed to be isotropic point radiators, described by the functional form
\begin{equation}
\label{eqn:ptsrc}
f_{\rm pt}(\bx,t;\bx_s) = w(t)\delta(\bx-\bx_s). 
\end{equation}
Source locations $\bx_s$ are assumed known (as is natural for active source methods), and the source {\em wavelet} $w(t)$ is to be found as part of the solution of \ref{eqn:esi}. A convenient choice of penalty operator $A$ is then multiplication by the {\em offset} $|\bx-\bx_s|$: its null space consists precisely of distributions of the form \ref{eqn:ptsrc}. 

More complex radiation characteristics may be accommodated with similar but more complex choice for the operator $A$. Since the core analysis is similar, this paper deals only with the simplest case \ref{eqn:ptsrc}.

The wavefield $u$ in this work is presumed to exist in all of Euclicean space-time: in other words, boundary effects have been removed from $u$, by surface-related multiple elimination or other techniques. Predicted data traces are simply the samples of one or more components of $u$ at receiver points $\bx_r$.

%The domain of wave propagation is denoted $\Omega$, and two subsets of its boundary are identified: $\Gamma_s$ contains the support (non-zeroes) of the (extended) sources and in particular the locations $\bx_s$ of physical sources. Data trace locations $\bx_r$ lie in another subset $\Gamma_r$. The data projection operator $P$ samples the acoustic field $u$ on $\Gamma_r$, and includes a finite aperture mute.  

Achieving a small residual in the source subproblem \ref{eqn:esis} for arbitrary $c$ is a critical part of the convergence mechanism for the extended source approach to FWI \cite[]{HuangNammourSymesDollizal:SEG19}. However, for arbitrary data $d$, coefficient array $c$, and source location $\bx_s$, there does not exist an isotropic point source $f_{\rm pt}$ of the form \ref{eqn:ptsrc} for which $PL[c]^{-1}f_{\rm pt} \approx d$. This is so even if there does exist a coefficient array $c^*$ and point source $f_{\rm pt}^*$ located at $\bx_s$ with wavelet $w^*(t)$ for which $d = PL[c^*]^{-1}f_{\rm pt}^*$, if $c$ differs substantially from $c^*$. It is this fact that underlies the effectiveness of the extended source approach to FWI:  driving the residual in the problem \ref{eqn:esi} towards zero necessarily requires modifying $c$ to resemble $c^*$, assuming the latter exists, as well as pushing the optimal $f$ towards the null space of $A$. Conversely, the source subproblem \ref{eqn:esis} does not have a small residual solution of point source form \ref{eqn:ptsrc}, in general, for a given choice of $c$, even if that were the case for a different choice ($c^*$). Therefore a more general class of source models than that specified by the condition \ref{eqn:ptsrc} must be admitted to the feasible set for the source subproblem \ref{eqn:esis} if it is to serve as the inner problem in a variable projection formulation of extended source FWI.

The class of non-point sources investigated here are those confined a hypersurface assumed to contain the locations of physical (point) sources, but not {\em a priori} required to have point support. These {\em surface extended sources} are able to yield a relatively small residual in the source subproblem \ref{eqn:esis} for more or less arbitrary coefficient array $c$. This observation is a by-product of the approximate solution for \ref{eqn:esis} constructed below. The construction of the approximate solution is closely related to the {\em time reversal} method of photoacoustic tomography (see \cite{StefanovUhlmannIP:09} and references cited there).

The next section gives a precise description of an acoustic version of problem \ref{eqn:esis} for an idealized {\em crosswell} configuration, in which source located on a surface $z=z_s$ generate waves that propagate to to a receiver surface $z=z_r > z_s$. In principle, {\em diving waves} can be described with similar mathematics, but with some additional complications, so I do not treat the diving wave case explicitly in this paper. The assumptions detailed here imply that the data $d$ of the inverse problems \ref{eqn:esi}, \ref{eqn:esis} have the physical character of {\em transmitted waves}. There are no mathematical results at present concerning reflected wave inverse problems treated by source extension methods, though there are tantalizing numerical clues \cite[]{LeeuwenHerrmannWRI:13,Warner:14,Warner:16,LeeuwenHerrmann:16,HuangSymes:Geo17,HuangSymes:Geo18a,HuangSymes:Geo18b}.

The following section describes the construction of the approximate
inverse and explains the conditions under which accuracy should be expected. I observe that the approximate inverse is approximately the adjoint of the modeling operator $PL[c]^{-1}$ with respect to weighted norms in its domain and range (see \cite{HouSymes:15} for a similar observation in a different context). This fact immediately suggests use of the approximate inverse as a preconditioner to accelerate convergence of Krylov space methods such as conjugate gradient iteration applied to the least squares problem \ref{eqn:esis}. However, its straightforward application in the preconditioned conjugate gradient (PCG) method \cite[]{Golub:2012} involves explicitly a version the so called Dirichlet-to-Neumann (D2N) operator, which is computationally awkward. I show how to reorganize the PCG iteration so that only solutions of $L[c]u=f$ are required. The penultimate section presents some 2D examples in the crosswell configuration, illustrating the accuracy of the approximate inversion and the accelerated convergence of PCG. The examples are chosen to emphasize that surface extended sources can be constructed to fit more or less arbitrary data, unlike point sources - as mentioned before, this approximate invertibility property of the modeling operator is of critical importance in the application to extended FWI. The paper ends with a discussion of several important matters not addressed here, and a restatement of the conclusions.

The intent of the main body of this paper is to present the formal structure of the extended source subproblem and the way in which this structure leads to accelerated numerical solution. This formal structure is however supported by a rigorous foundation. In order to avoid disrupting the formal account, this foundation material is relegated to an appendix.

\bibliographystyle{seg}
\bibliography{../../bib/masterref}


