\title{Efficient Computation of Extended Sources}
\author{William. W. Symes \thanks{The Rice Inversion Project,
Department of Computational and Applied Mathematics, Rice University,
Houston TX 77251-1892 USA, email {\tt symes@caam.rice.edu}.}}

\lefthead{Symes}

\righthead{Approximate Source Inversion}

\maketitle
\begin{abstract}
Source extension is a reformulation of inverse problems in wave propagation, that at least in some cases leads to computationally tractable iterative solution methods. The core subproblem in all source extension methods is the solution of a linear inverse problem for a source (right hand side in a system of wave equations) through minimization of data error in the least squares sense with soft imposition of physical constraints on the source via an additive quadratic penalty. A variant of the time reversal method from photoacoustic tomography provides an approximate solution that can be used to precondition Krylov space iteration for rapid convergence to the solution of this subproblem. An acoustic 2D example for sources supported on a surface, with a soft contraint enforcing point support, illustrates the effectiveness of this preconditioner.
\end{abstract}

\section{Introduction}
Full Waveform Inversion (FWI) can be described in terms of 
\begin{enumerate}
\item a linear wave operator $L[c]$, depending on an array of space-dependent coefficients $c$ and acting on wavefields $u$ vanishing in negative time:
\begin{equation}
\label{eqn:init}
u \equiv 0, t \ll 0; 
\end{equation}
\item a trace sampling operator $P$ acting on wavefields and producing data traces;
\item and a source function (of space and time) $f$ representing energy input to the system. 
\end{enumerate}
The basic FWI problem is: given data $d$, find $c$ so that 
\begin{equation}
\label{eqn:fwi}
Pu \approx d \mbox{ and } L[c]u = f.
\end{equation}

The energy source $f$ may also be largely undetermined, apart from some known characteristics such as localization in space and/or time. In fact, additional source degrees of freedom, beyond those needed to describe physically realized sources, may be useful in rendering the FWI problem \ref{eqn:fwi} more amenable to numerical solution, via so-called extended modeling (see \cite{geoprosp:2008}, \cite{LeeuwenHerrmannWRI:13}, \cite{HuangNammourSymesDollizal:SEG19}, and many references cited there). Therefore it is natural to view $f$ as also an unknown in formulating the problem \ref{eqn:fwi} via nonlinear least squares:
%A typical nonlinear least squares formulation is:
%\begin{equation}
%\label{eqn:ols}
%\mbox{choose } c \mbox{ to minimize } \|PL[c]^{-1}f -d \|^2.
%\end{equation}

%As is well-known, local optimization methods are the only feasible approach given the dimensions of a typical instance of \ref{eqn:fwi}, and those have a tendency to stall due to ``cycle-skipping''. Source extension is one approach to avoiding this problem. It consists in imposing the wave equation as a soft as opposed to hard constraint, by allowing the source to have more degrees of freedom than is permitted by a faithful  model model of the seismic experiment, and constraining these additional degrees of freedom by means of an additive penalty modifying the probem \ref{eqn:ols}:
\begin{equation}
\label{eqn:esi}
\mbox{choose } c, f \mbox{ to minimize } \|PL[c]^{-1}f -d \|^2 + \alpha^2 \|Af\|^2 
\end{equation}
The operator $A$ penalizes deviation from known (or assumed) characteristics of the source function - its null space consists of feasible source models. 

This paper presents a numerically efficient approach to solving the {\em source subproblem}
\begin{equation}
\label{eqn:esis}
\mbox{given } c, \mbox{ choose } f \mbox{ to minimize } \|PL[c]^{-1}f -d \|^2 + \alpha \|Af\|^2 
\end{equation}

The penalty operator $A$ is assumed linear in this work, so the source subproblem is a linear least squares problem. Under some additional assumptions to be described below, I shall show how to construct an accurate approximate solution operator for problem \ref{eqn:esis}. This approximate solution operator may be used to accelerate Krylov space methods for the solution of the source subproblem \ref{eqn:esis}. Numerical examples suggest the effectiveness of this acceleration.

The source subproblem is a necessary step in solving the overall FWI problem \ref{eqn:fwi}. In particular, the nonlinear least squares realization \ref{eqn:esi} of source-extended FWI is naturally approached via the {\em variable projection method} \cite[]{GolubPereyra:73,GolubPereyra:03,vanLeeuwenMulder:09,Rickett:SEG12}, in which the minimum over $f$ in \ref{eqn:esis} is treated as a function of $c$, which is in turn minimized. Variable projection thus treats the source subproblem as an inner problem, which must be solved for an estimate of $f$ at every step of an iterative method for the outer problem of minimization over $c$. Efficiency in solving the source subproblem \ref{eqn:esis} is critical to efficient implementation of variable projection for solving the regularized FWI problem \ref{eqn:esi}.

This paper restricts the choice of wave physics embodied in $L[c]$ to linear acoustics.  The principal characteristics assumed of sources are localization and isotropy. That is, physical sources will be assumed to be isotropic point radiators, described by the functional form
\begin{equation}
\label{eqn:ptsrc}
f_{\rm pt}(\bx,t;\bx_s) = w(t)\delta(\bx-\bx_s). 
\end{equation}
Source locations $\bx_s$ are assumed known (as is natural for active source methods), and the source {\em wavelet} $w(t)$ is to be found as part of the solution of \ref{eqn:esi}. A convenient choice of penalty operator $A$ is then multiplication by the {\em offset} $|\bx-\bx_s|$: its null space consists precisely of distributions of the form \ref{eqn:ptsrc}. 

More complex radiation characteristics may be accommodated with similar but more complex choice for the operator $A$. Since the core analysis is similar, this paper deals only with the simplest case \ref{eqn:ptsrc}.

The wavefield $u$ in this work is presumed to exist in all of Euclicean space-time: in other words, boundary effects have been removed from $u$, by surface-related multiple elimination or other techniques. Predicted data traces are simply the samples of one or more components of $u$ at receiver points $\bx_r$.

%The domain of wave propagation is denoted $\Omega$, and two subsets of its boundary are identified: $\Gamma_s$ contains the support (non-zeroes) of the (extended) sources and in particular the locations $\bx_s$ of physical sources. Data trace locations $\bx_r$ lie in another subset $\Gamma_r$. The data projection operator $P$ samples the acoustic field $u$ on $\Gamma_r$, and includes a finite aperture mute.  

Achieving a small residual in the source subproblem \ref{eqn:esis} for arbitrary $c$ is a critical part of the convergence mechanism for the extended source approach to FWI \cite[]{HuangNammourSymesDollizal:SEG19}. However, for arbitrary data $d$, coefficient array $c$, and source location $\bx_s$, there does not exist an isotropic point source $f_{\rm pt}$ of the form \ref{eqn:ptsrc} for which $PL[c]^{-1}f_{\rm pt} \approx d$. This is so even if there does exist a coefficient array $c^*$ and point source $f_{\rm pt}^*$ located at $\bx_s$ with wavelet $w^*(t)$ for which $d = PL[c^*]^{-1}f_{\rm pt}^*$, if $c$ differs substantially from $c^*$. It is this fact that underlies the effectiveness of the extended source approach to FWI:  driving the residual in the problem \ref{eqn:esi} towards zero necessarily requires modifying $c$ to resemble $c^*$, assuming the latter exists, as well as pushing the optimal $f$ towards the null space of $A$. Conversely, the source subproblem \ref{eqn:esis} does not have a small residual solution of point source form \ref{eqn:ptsrc}, in general, for a given choice of $c$, even if that were the case for a different choice ($c^*$). Therefore a more general class of source models than that specified by the condition \ref{eqn:ptsrc} must be admitted to the feasible set for the source subproblem \ref{eqn:esis} if it is to serve as the inner problem in a variable projection formulation of extended source FWI.

The class of non-point sources investigated here are those confined a hypersurface assumed to contain the locations of physical (point) sources, but not {\em a priori} required to have point support. These {\em surface extended sources} are able to yield a relatively small residual in the source subproblem \ref{eqn:esis} for more or less arbitrary coefficient array $c$. This observation is a by-product of the approximate solution for \ref{eqn:esis} constructed below. The construction of the approximate solution is closely related to the {\em time reversal} method of photoacoustic tomography (see \cite{StefanovUhlmannIP:09} and references cited there).

The next section gives a precise description of an acoustic version of problem \ref{eqn:esis} for an idealized {\em crosswell} configuration, in which source located on a surface $z=z_s$ generate waves that propagate to to a receiver surface $z=z_r > z_s$. In principle, {\em diving waves} can be described with similar mathematics, but with some additional complications, so I do not treat the diving wave case explicitly in this paper. The assumptions detailed here imply that the data $d$ of the inverse problems \ref{eqn:esi}, \ref{eqn:esis} have the physical character of {\em transmitted waves}. There are no mathematical results at present concerning reflected wave inverse problems treated by source extension methods, though there are tantalizing numerical clues \cite[]{LeeuwenHerrmannWRI:13,Warner:14,Warner:16,LeeuwenHerrmann:16,HuangSymes:Geo17,HuangSymes:Geo18a,HuangSymes:Geo18b}.

The following section describes the construction of the approximate inverse and explains the conditions under which accuracy should be expected. I observe that the approximate inverse is approximately the adjoint of the modeling operator $PL[c]^{-1}$ with respect to weighted norms in its domain and range (see \cite{HouSymes:15} for a similar observation in a different context). This fact immediately suggests use of the approximate inverse as a preconditioner to accelerate convergence of Krylov space methods such as conjugate gradient iteration applied to the least squares problem \ref{eqn:esis}. However, its straightforward application in the preconditioned conjugate gradient (PCG) method \cite[]{Golub:2012} involves explicitly a version the so called Dirichlet-to-Neumann (D2N) operator, which is computationally awkward. I show how to reorganize the PCG iteration so that only solutions of $L[c]u=f$ are required. The penultimate section presents some 2D examples in the crosswell configuration, illustrating the accuracy of the approximate inversion and the accelerated convergence of PCG. The examples are chosen to emphasize that surface extended sources can be constructed to fit more or less arbitrary data, unlike point sources - as mentioned before, this approximate invertibility property of the modeling operator is of critical importance in the application to extended FWI. The paper ends with a discussion of several important matters not addressed here, and a restatement of the conclusions.

The intent of the main body of this paper is to present the formal structure of the extended source subproblem and the way in which this structure leads to accelerated numerical solution. This formal structure is however supported by a rigorous foundation. In order to avoid disrupting the formal account, this foundation material is relegated to an appendix.

\section{Operators and Adjoints}

For acoustic wave physics, the coefficient vector $c$ is the pair $c=(\kappa,\beta)$ of bulk modulus $\kappa$ and density $\rho$, and the state vector $u=(p,\bv)^T$ consists of pressure $p$ (a scalar space-time field) and particle velocity $\bv$ (a vector space-time field). The wave operator $L[c]$ is given by the linear acoustics system:
\begin{equation}
\label{eqn:aweop}
L[c]u = 
\left(
\begin{array}{c}
\frac{1}{\kappa}\frac{\partial p}{\partial t}  + \nabla \cdot \bv, \\
\rho\frac{\partial \bv}{\partial t} + \nabla p.
\end{array}
\right) 
\end{equation}
That is,
\begin{equation}
  \label{eqn:awemat}
  L[c] = \left(
    \begin{array}{cc}
      \frac{1}{\kappa}\frac{\partial}{\partial t} & \nabla \cdot \\
      \nabla & \rho \frac{\partial}{\partial t}
    \end{array}
  \right)
\end{equation}

The space dimension is $d$. Most of what follows is valid for any $d >0$. Examples later in this paper will use $d=2$ for computationally convenience.

As mentioned earlier, in this paper the coefficients $c$ is regarded as defined throughout space $\bR^d$, the state vector $u$ throughout space-time $\bR^{d+1}$.

The idealized ``crosswell'' configuration involves sources confined to $z=z_s$. I will mostly represent sources as constitutive law defects, that is, right-hand sides in the system $L[c]u=f$ of the form $f(\bx,t) = (h_s(x,y,t)\delta(z-z_s), {\bf 0})^T$. With the choice $L[c]$ given in \ref{eqn:aweop}, the causal wave system $L[c]u^+=f$ takes the form
\begin{eqnarray}
\label{eqn:awep}
\frac{1}{\kappa}\frac{\partial p^{+}}{\partial t} & = & - \nabla \cdot \bv^{+} +
h_s \delta(z-z_s), \nonumber \\
\rho\frac{\partial \bv^{+}}{\partial t} & = & - \nabla p^{+},\nonumber \\
p^{+} & =& 0 \mbox{ for } t \ll 0,\nonumber\\ 
\bv^{+} & = & 0 \mbox{ for } t \ll 0.
\end{eqnarray}

Similarly, the anti-causal wave system $L[c]u^-=f$ takes the form
\begin{eqnarray}
 \label{eqn:awem}
\frac{1}{\kappa}\frac{\partial p^{-}}{\partial t} & = & - \nabla \cdot \bv^{-} +
h_s \delta(z-z_s), \nonumber \\
\rho \frac{\partial \bv^{-}}{\partial t} & = & - \nabla p^{-},\nonumber \\
p^{-} & =& 0 \mbox{ for } t \gg 0,\nonumber\\ 
\bv^{-} & = & 0 \mbox{ for } t \gg 0.
\end{eqnarray}
Sampling the causal pressure field $p^{+}$ on the surface $z=z_r$ defines the causal forward modeling operator $S^{+}_{z_s,z_r}[c]$:
\begin{equation}
  \label{eqn:fwd}
  S^{+}_{z_s,z_r}[c]h_s = p^+|_{z=z_r}
\end{equation}
The anti-causal forward modeling operator $S^-_{z_s,z_r}$ has a similar definition.
The subscript signifies that sources are located on $z=z_s$, the receivers on $z=z_r$. It's necessary to include this information in the notation, as versions of $S$ with sources and receivers in several locations will be needed in the discussion below.

The adjoint of $S^+_{z_s,z_r}[c]$ can be computed
by a variant of the adjoint state method, in this case a by-product of the conservation of energy. Suppose that $p^-,\bv^-$ solve \ref{eqn:awem} with $h_s\delta(z-z_s)$ replaced by $ h_r \delta(z-z_r)$. Then
\[
0 = 
\left(\int\, dx\,dy\,dz\, \frac{p^+ p^-}{\kappa} +  
\rho \bv^+ \cdot \bv^- \right)|_{t \rightarrow \infty}
-
\left(\int\, dx\,dy\,dz\, \frac{p^+ p^-}{\kappa} +  \rho \bv^+ \cdot \bv^- \right)|_{t \rightarrow -\infty}
\]
\[
= 
\int_{-\infty}^{\infty} \,dt\, \frac{d}{dt}\left(\int\, dx\,dy\,dz\, \frac{p^+ p^-}{\kappa} +  \rho \bv^+ \cdot \bv^- \right)
\]
\[
= 
\int_{-\infty}^{\infty} \,dt\, \left(\int\, dx\,dy\,dz\, \frac{1}{\kappa} \frac{\partial p^+}{\partial t} p^- +  p^+ \frac{1}{\kappa}\frac{\partial p^-}{\partial t} \right.
\]
\[
+
\left. \rho \frac{\partial \bv^+}{\partial t} \cdot \bv^- + \rho \bv^+ \cdot \frac{\partial \bv^-}{\partial t} \right)
\]
\[
= 
\int_{-\infty}^{\infty} \,dt\, \left(\int\, dx\,dy\,dz\, \left(- \nabla \cdot \bv^+ + 
 h_s \delta(z-z_s)\right) p^- + p^+ \left(- \nabla \cdot \bv^- + 
 h_r \delta(z-z_r)\right) \right.
\]
\[
+
\left.  (- \nabla p^+) \cdot \bv^- + \bv^+ \cdot (-\nabla p^-) \right)
\]
\[
= 
\int_{-\infty}^{\infty}\,dt\, \left(\int\, dx\,dy\,dz\, \left(- \nabla \cdot \bv^+ + 
 h_s \delta(z-z_s)\right) p^- + p^+ \left(- \nabla \cdot \bv^- + 
 h_r \delta(z-z_r)\right) \right.
\]
\[
+
\left.  p^+ (\nabla \cdot \bv^-) + (\nabla \cdot \bv^+) p^- \right)
\]
after integration by parts in the last two terms. Most of what is left cancels, leaving 
\[
0 = \int_{-\infty}^{\infty}\,dt\,dx\,dy\, h_sp^-|_{z=z_s} +  h_rp^+|_{z=z_r} = \langle h_s, p^-|_{z=z_s}\rangle + \langle h_r, S[c]^+_{z_s,z_r}[c]h_s \rangle
\]
whence
\begin{equation}
\label{eqn:sadj}
 S^+_{z_s,z_r}[c]^T h_r = -p^-|_{z=z_s}
\end{equation}

The systems \ref{eqn:awep} and \ref{eqn:awem} differ only in the direction of time evolution (causal vs. anti-causal). Define $R$ to be the {\em time-reversal operator} on functions of space-time,
$Rf(\bx,t) = f(\bx,-t)$, and ${\cal R}$ to be the {\em acoustic field time-reversal operator} 
\begin{equation}
  \label{eqn:trdef}
  {\cal R} \left(
    \begin{array}{c}
      p\\
      \bv
    \end{array}
  \right) =
  \left(
    \begin{array}{c}
      Rp\\
      -R\bv
    \end{array}
  \right)
\end{equation}
Then ${\cal R}(p^-,\bv^-)$ solves \ref{eqn:awep} with $h_s\delta(z-z_s)$ replaced by $-Rh_r\delta(z-z_r)$. That is,
\begin{equation}
  \label{eqn:trsadj}
  Rp^-|_{z=z_s} = -S^+_{z_r,z_s}[c]Rh_r
\end{equation}
Since $R^2 = I$ and ${\cal R}^2 = I$, the identities \ref{eqn:sadj} and \ref{eqn:trsadj} imply that
\begin{equation} 
  \label{eqn:trtr}
  S^+_{z_s,z_r}[c]^T = RS^+_{z_r,z_s}[c]R.
\end{equation}

\section{Surface source-to-pressure operator}

A particular case of the relation \ref{eqn:trtr} is important in its own right, when $z_r=z_s$. Define surface source-to-pressure operator $\Lambda_{z_s}$ by
\begin{equation}
  \label{eqn:ntoddef}
  \Lambda_{z_s} = S^+_{z_s,z_s}.
\end{equation}
Then \ref{eqn:trtr} reads
\begin{equation}
  \label{eqn:ntodtr}
  \Lambda_{z_s}^T = R\Lambda_{z_s}R.
\end{equation}
This operator is closely related to the operator mapping $\lim_{z\rightarrow z_s^+} \bv_z^+$ to $\lim_{z\rightarrow z_s^+}  p^+$, often called the {\em Neumann-to-Dirichlet} operator. The connection is explained below.

The quadratic form defined by $\Lambda_{z_s}$ has fundamental physical significance. Suppose that the surface source $h_s$ vanishes outside of a bounded time interval $[t_{\rm min},t_{\rm max}]$. Then the causal acoustic field $(p^+,\bv^+)$, solution of the system \ref{eqn:awep}, vanishes for $t<t_{\rm min}$. Define the total acoustic energy $E(t)$ at time $t$ by
\begin{equation}
  \label{eqn:defae}
  E(t) = \frac{1}{2} \int \,d\bx \, \left(\frac{(p^+)^2}{\kappa} + \rho |\bv^+|^2\right)
\end{equation}
Then since $E(t_{\rm min})=0$,
\[
  E(t_{\rm max}) = \int_{t_{\rm min}}^{t_{\rm max}} \frac{dE}{dt}
\]
\[
  = \int_{t_{\rm min}}^{t_{\rm max}} \int\,d\bx\, \left(p^+ \frac{1}{\kappa}\frac{\partial p^+}{\partial t} + \bv^+ \cdot \rho \frac{\partial \bv^+}{\partial t}\right)
\]
\[
  =\int_{t_{\rm min}}^{t_{\rm max}} \int\,d\bx\,\left(p^+(-\nabla \cdot \bv^{+} + h_s\delta(z-z_s)) + \bv^+ \cdot \rho \frac{\partial \bv^+}{\partial t}\right)
\]
\[
  \int_{t_{\rm min}}^{t_{\rm max}}\int\,d\bx\, \left(\left(\nabla p^+\rho \frac{\partial \bv^+}{\partial t}\right) + p^+h_s\delta(z-z_s)\right)
\]
\[
  =  \int_{t_{\rm min}}^{t_{\rm max}}\int\,dxdy h_s p^+|_{z=z_s} = \langle h_s, \Lambda_{z_s} h_s \rangle.
\]
Since the source $h_s\delta(z-z_s)$ no longer acts on the fluid for $t >t_{\rm max}$, $E_{\rm tot}= E(t_{\rm max})$ is the total energy transferred from the source to the fluid, and
\begin{equation}
  \label{eqn:surfenergy}
  E_{\rm tot} = \langle h_s, \Lambda_{z_s} h_s \rangle.
\end{equation}
We can conclude from identity \ref{eqn:surfenergy} that the symmetric part of $\Lambda_{z_s}$ is positive semidefinite:
\begin{equation}
  \label{eqn:lamsd}
  \frac{1}{2}(\Lambda_{z_s}^T + \Lambda_{z_s}) \ge 0.
\end{equation}

Observe that the causal acoustic system \ref{eqn:awep} implies directly that
\begin{equation}
  \label{eqn:sourcevjump}
  h_s= [v_z]|_{z_s}.
\end{equation}

\section{Progressing Waves and Symbols}

The symbol $\sigma(L[c])$ of a matrix operator $L[c]$ is a complex scalar-valued matrix of the same size. In terms of its product with an arbitrary vector $\bu \in \bR^{d+1}$, it is
\[
  \sigma(L[c]) \bu = e^{-i(\omega t + \bk \cdot \bx)} (L[c]e^{i(\omega t + \bk \cdot \bx)}\bu).
\]
For $L[c]$ given by the definition \ref{eqn:awemat}, obtain
\begin{equation}
  \sigma(L[c])(t,\bx,\omega,\bk) = i\left(
    \begin{array}{cc}
      \frac{\omega}{\kappa(\bx)} & \bk^T \\
      \bk & \rho(\bx) \omega)
    \end{array}
  \right)
\end{equation}

The characteristic equation of $L[c]$ is $\det \sigma(L[c]) = 0$. The significance of the characteristic equation is its role in constraining the phase $\psi(\bx)$ in the progressing wave ansatz,
\begin{equation}
  \label{eqn:go}
  \bu(\bx,t) = e^{i\omega (t-\psi(\bx))} \ba (\bx).
\end{equation}
Applying $L[c]$ to this ansatz, obtain
\[
  L[c]\bu(\bx,t)=i \omega
  \left(
    \begin{array}{c}
      \frac{1}{\kappa}a_p -  \nabla \psi \cdot \ba_v \\
      -a_p \nabla \psi + \rho \ba_v
    \end{array}
  \right) + ...
\]
\[
  = i \omega \sigma(L[c])(t,\bx,1,- \nabla \psi(\bx))ba + ...
\]
where ``$...$'' denotes terms of lower order in $\omega$. Thus $\bu$ as defined in equation \ref{eqn:go} is a high-frequency asymptotic solution, $L[c]\bu \approx 0$, if
\begin{itemize}
\item
  \begin{equation}
    \label{eqn:eik}
    \det(\sigma(L[c])(t,\bx,1,-\nabla \psi(\bx))) = 0,
  \end{equation}
  (eikonal equation), and
\item
  $\ba$ is a null vector of $\sigma(L[c])(t,\bx,1,-\nabla \psi)$.
\end{itemize}
Explicitly, the eikonal equation reads
\[
  0 = \rho^2\left(\frac{\rho}{\kappa}-|\nabla \psi|^2\right),
\]
equivalent to the familar form
\begin{equation}
  \label{eqn:usualeik}
  c|\nabla \psi| = 1,
\end{equation}
in which $c = \rho/\kappa$ is the wave velocity. Solution via the method of characteristics gives
\[
  \psi(\bx(t)) = \psi(\bx(0)) + t
\]
for a ray $t \mapsto \bx(t)$ satisfying
\[
  \frac{d\bx}{dt}(t) = -c(\bx)^2\nabla \psi(\bx(t))
\]
Finally, $\ba$ is a null vector of $\sigma(L[c])(\cdot,\cdot,1,-\nabla \psi)$ iff
\begin{equation}
  \label{eqn:godton}
  \ba_v = \frac{a_p}{\rho}\nabla \psi
\end{equation}
The scalar $a_p$ evolves along the ray according to the transport equation, which I will not derive here; suffice it to say that $a_p(t) = a_p(0) \gamma(t)$, where $\gamma > 0$ is smooth and $\gamma(0)=1$.

Suppose that $\bx_0 = (x,y,z_s)^T$ and $(\xi_x,\xi_y) \in \bR^2$ satisfies $c(\bx_0)|(\xi_x,\xi_y)|<1$. Then there is a neighborhood $\Omega$ of $\bx_0$ and $\xi_z \in C^{\infty}(\Omega), \xi_z>0$, so that $\bxi^{\pm}(\bx)=(\xi_x,\xi_y,\pm \xi_z(\bx))$ satisfy $c(\bx)|\bxi^{\pm}(\bx)|=1$ for $\bx \in \Omega$.

A standard argument shows that there exists $\epsilon > 0$ for which a solution $\psi^{\pm}$ of the eikonal equation exists in $\Omega \cap \{\bx: |z-z_s|<\epsilon\}$ with
\begin{equation}
  \label{eqn:eikic}
  \psi^{\pm}(x,y,z_s,t) = t -x \xi_x - y \xi_y, \, \frac{\partial \psi}{\partial z}(x,y,z_s,t) = \pm \xi_z(x,y,z_s).
\end{equation}
Let $\chi \in C_0^{\infty}, \chi(\bx_0)=1$, and set $p_0^{\pm}(x,y,t) = \chi(x,y,z_s)e^{i\omega(t-x\xi_x - y\xi_y)}$. Define $p_{\rm go}^{\pm} \in C^{\infty}(\Omega \cap \{\bx: |z-z_s|<\epsilon\})$ by
\[
  p_{\rm go}^{\pm}(\bx,t) = a^{\pm}_p(\bx) e^{i\omega (t-\psi^{\pm}(\bx))}.
\]
where $a^{\pm}_p$ solves the transport equation with $a^{\pm}_p|_{z=z_s} = \chi$. Set
\[
  \bv^{\pm}_{\rm go}(\bx,t) = \frac{a^{\pm}_p(\bx)}{\rho(\bx)}\nabla \psi^{\pm}(\bx) e^{i\omega (t-\psi^{\pm}(\bx))}
\]
Then $\bu^{\pm}_{\rm go} = (p^{\pm}_{\rm go}, \bv^{\pm}_{\rm go})$ is an asymptotic solution of $L[c]\bu = 0$ with $p^{\pm}_{\rm go}|_{z=z_s} = \chi e^{i\omega(t-x\xi_x - y\xi_y)}$.

From equations \ref{eqn:godton} and \ref{eqn:eikic},
\[
  v_{z,{\rm go}}^{\pm}(x,y,z_s,t) = \pm \frac{\chi(x,y,t)}{\rho(x,y,z_s)}\xi_z  e^{i\omega(t-x\xi_x - y\xi_y)}
\]
\begin{equation}
  \label{eqn:asymdton}
= \pm \frac{\chi(x,y,t)}{\rho(x,y,z_s)c(x,y,z_s)}\sqrt{1-c(x,y,z_s)^2(\xi_x^2+\xi_y^2)}
\end{equation}

Integration over frequency produces a progressing wave traveling (at least near $z=z_s$) downwards, that is, increasing $z$ with increasing $t$, for the choice of sight $\pm = +$, and upwards, that is, decreasing $z$ with increasing $t$, for the other sign. Therefore a causal progressing wave with $p$ given on $z=z_s$ is obtained by synthesizing distorted plane waves as just described with $\pm = +$ in $z>z_s$, $\pm=-$ in $z<z_s$. From equation \ref{eqn:asymdton}, the normal components of $\bv$ have limits equal in magnitude but of opposite sign as $z\rightarrow 0^{\pm}$, up to a lower frequency error. That is, the jump in $\bv$ satisfies
\begin{equation}
  \label{eqn:asymjump}
  [v_z]\approx \lim_{z\rightarrow 0^+} v_{z}
\end{equation}
where $\approx$ denotes ``up to a low frequency error'', from here on.

This construction also implies an approximation of the source-to-pressure operator as a pseudodifferential operator. Choose a partition of unity in $z=z_s$, for which the support of every member is a domain $\Omega$ for which the construction above can be carried out: this implies that there be a uniform $\delta > 0$ so that
\begin{equation}
  \label{eqn:nongraze}
  1>\delta + c(x,y,z_s)\sqrt{\xi_x^2+\xi_y^2}
\end{equation}
for all $(x,y,t,1,\xi_x,\xi_y) \in WF(p_0)$. Denote by $\Gamma$ the subset of $(x,y,t,k_x,k_y,\omega) \in T^*(\bR^3)$ for which $x,y,\xi_{xy}=k_{xy}/\omega$ satisfy the inequality \ref{eqn:nongraze}.

Then near $z=z_s$, $p$ is approximately a sum of geometric optics solutions of the type displayed above, integrated over $\omega,k_x,k_y$, with $k_{x,y} = \omega \xi_{x,y}$.  Thus
\[
  p(x,y,z_s,t) \approx \frac{1}{2}\int_{\Gamma(x,y)} \,d\omega\,dk_x\,dk_y \hat{[v_z]}\rho(x,y,z_s)c(x,y,z_s)
\]
\[
   \times \left(1-c^2(x,y,z_s)\left(\left(\frac{k_x}{\omega}\right)^2 + \left(\frac{k_y}{\omega}\right) ^2\right)\right)^{-1/2}e^{\i(\omega t + k_x x+ k_y y)}
\]
Since $p$ is the pressure component of a solution of \ref{eqn:awep}, equation \ref{eqn:sourcevjump} implies that
\begin{equation}
  \label{eqn:psidodton}
  \Lambda_s h_s(x,y,t) \approx \frac{1}{2}\int_{\Gamma(x,y)} \,d\omega\,dk_x\,dk_y
  \lambda_s(x,y,t,k_x,k_y,\omega) \hat{h_s}(k_x,k_y,\omega) e^{\i(\omega t + k_x x+ k_y y)}
\end{equation}
with
\begin{equation}
  \label{eqn:symboldton}
  \lambda_s(x,y,t,k_x,k_y,\omega) =\frac{1}{2}\rho(x,y,z_s)c(x,y,z_s)\left(1-c^2(x,y,z_s)\left(\left(\frac{k_x}{\omega}\right)^2 + \left(\frac{k_y}{\omega}\right) ^2\right)\right)^{-1/2}
\end{equation}

Restricted to $\Gamma$, $\lambda \in S^0_{0,1}(\bR^2)$ is real-valued, hence defines an essentially symmetric operator. That is,
\begin{equation}
  \label{eqn:approxsymm}
  \Lambda_s^T \approx \Lambda_s.
\end{equation}

\section{Parametrix via Time-reversal}

Both $S[c]^T$ and $S[c]^{\dagger}$ are defined by time-reversed solutions of the same acoustic system, except with different data:
\begin{itemize}
\item system \ref{eqn:aweadj} inputs $d_r$ as a pressure source on $z=z_r$, with an additional factor of $\kappa$, and outputs the trace of the reverse-time propagated field on $z=z_s$, scaled by $1/\kappa$, to obtaint $S[c]^Td_r$;
\item system \ref{eqn:awetr} inputs $d_r$ as a Dirichlet boundary condition, and the trace of its pressure component must be employed as a Dirichlet boundary condition for the forward-in-time problem \ref{eqn:awedir}, after which the jump in the normal velocity is extracted.
\end{itemize}

The relation between a Dirichlet boundary condition and a source has already been explained, in the context of justifying the approximation property of $S[c]^{\dagger}$:
\begin{quote}
The surface source producing the same field as a Dirichlet boundary condition (on either side of the boundary surface) is the jump in the normal velocity component of the Dirichlet field. 
\end{quote}
Call the operator that produces the jump in normal velocity from Dirichlet pressure data $\Lambda[c]_s$ for the source surface $z=z_s$ and forward in time, $\Lambda[c]_r$ for the receiver surface $z=z_r$ backwards in time (in the math literature, these are ``Dirichlet-to-Neumann operators'', more or less).

\cite{HouSymes:EAGE16} demonstrated a very similar preconditioner for Least Squares Migration, also for its subsurface offset extension \cite[]{HouSymes:16}, motivated by \cite{tenKroode:12}. These constructions all involve the Dirichlet-to-Neumann operator. This concept also turns up in hidden form in the work of Yu Zhang and collaborators on true amplitude migration \cite[]{YuZhang:14,TangXuZhang:13,XuWang:2012,XuZhangTang:11,Zhang:SEG09,Zhang YuSun:08,ZhangSunGray:07,ZhangBleistein:05,Bleisteinetal:05}. 

\section{Efficient Preconditioned CG}

The discussion so far can be summarized as follows: an efficient pseudoinverse for $S[c]$ is the weighted adjoint operator
\begin{equation}
\label{eqn:wadj}
S[c]^{\dagger} = W[c]_m^{-1}S[c]^TW[c]_d,
\end{equation}
in which 
\begin{equation}
\label{eqn:weights}
W[c]_m = \kappa^{-1}\Lambda[c]^{-1}_s,\,\, W[c]_d = \kappa^{-1}\Lambda[c]_r
\end{equation}
Here ``$\kappa$'' means the operator ``multiply by $\kappa$''.

The statement that $S[c]^{\dagger}$ is the weighted adjoint of $S[c]$ means that $S[c]^{\dagger}$ {\em is} the adjoint of $S[c]$ with respect to weighted norms 
\begin{itemize}
\item on the source space ($h_s$): weight $W[c]_m$
\item on the data space ($d_r$): weight $W[c]_d$
\end{itemize}
Since $S[c]^{\dagger}S[c] \approx I$ in subspaces of the domain space, as shown above, $S[c]$ is approximately unitary in (subspaces of) the Hilbert spaces of source and data traces with norms defined by the weighting operators $W_m$ and $W_d$ respectively. Therefore a Krylov space method employing these norms will converge rapidly, at least for the well-determined components of the solution.

The most convenient arrangement the CG algorithm taking advantage of the structure \ref{eqn:wadj} is the {\em Preconditioned CG}. Since the coefficient array $c$ will remain unchanged during the iteration, write $S$ instead of $S[c]$, etc. 

Allowing that the fit error will be measured by the data space norm, the least squares problem to be solved is not just $Sh \approx d$, but a regularized version:
\begin{equation}
  \label{eqn:einv}
  \mbox{minimize}_h \|Sh-d\|^2_d + \alpha^2 \|Ah\|^2_m
\end{equation}

[The modified data space norm $\|d\|_d^2 = \langle d, W_d d\rangle$ has physical meaning: for acoustics, it is proportional to the power transmitted through the surface $z=z_r$.]

The minimizer of the objective defined in equation \ref{eqn:einv} solves the normal equation
\begin{equation}
  \label{eqn:norm}
  (S^{\dagger}S + \alpha^2 A^{\dagger}A)h = S^{\dagger}d 
\end{equation}

where the weighted adjoint $S^{\dagger}$ has already been defined in equation \ref{eqn:wadj}, and $A^{\dagger}$ is the adjoint of $A$ in the weighted model space norm defined by $W_m$, namely
\begin{equation}
  \label{eqn:aadj}
  A^{\dagger} = W_m^{-1}A W_m.
\end{equation}

Introducing these definitions in the normal equation \ref{eqn:norm},
\begin{equation}
  \label{eqn:norm1}
  W_m^{-1}(S^TW_dS + \alpha^2 A^TW_mA)h = W_m^{-1}S^TW_md 
\end{equation}
Since $W_m$ is self-adjoint and positive definite, the common factor on both sides of \ref{eqn:norm1} can be re-written as

write $S^*, A^*$ for the adjoints with the original (Euclidean) inner product in the domains but the weighted inner product in data space:
\begin{equation}
  \label{eqn:normpart}
  Nh = (S^*S + \alpha^2 A^*A)h = S^*d 
\end{equation}
using the ``partly weighted'' adjoints
\begin{eqnarray}
  \label{eqn:sadj}
  S^* &=& S^T W_d,\\
  A^* &=& A^T W_m.
\end{eqnarray}
The Preconditioned Conjugate Gradient (``PCG'') algorithm for solution of equation \ref{eqn:normpart} with preconditioner $W_m$ is usually written as Algorithm 1.

\begin{algorithm}[H]
\caption{Preconditioned Conjugate Gradient Algorithm, Standard Version}
\begin{algorithmic}[1]
\State Choose $h_0=0$ 
  \State $r_0 \gets S^*d$
  \State $p_0 \gets W_m^{-1}r_0$
  \State $g_0 \gets p_0$
  \State $q_0 \gets Np_0$
  \State $k \gets 0$
  \Repeat
  \State $\alpha_k \gets \frac{\langle g_k,r_k \rangle}{\langle p_k,q_k\rangle}$
  \State $h_{k+1} \gets h_k + \alpha_k p_k$
  \State $r_{k+1} \gets r_k - \alpha_kq_k$
  \State $g_{k+1} \gets W_m^{-1}r_{k+1}$
  \State $\beta_{k+1} \gets \frac{\langle g_{k+1},r_{k+1}\rangle}{\langle g_k,r_k\rangle}$
  \State $p_{k+1}\gets g_{k+1}+\beta_{k+1}p_k$
  \State $q_{k+1} \gets Np_{k+1}$
  \State $k \gets k+1$
  \Until{Error is sufficiently small, or max iteration count exceeded} 
\end{algorithmic}
\end{algorithm}

The operator whose eigenvalue spectrum determines the speed of convergence here is the preconditioned normal operator
\begin{equation}
  \label{eqn:pno}
  W_m^{-1}N = S^{\dagger}S +\alpha^2 A^{\dagger}A
\end{equation}
This isn't just an approximate identity on a subspace, as $S^{\dagger}S$ is. The addition of the penalty term affects the spectrum, pushing parts of it away from $1$. I have not yet analyzed this effect, however for the ``in-aperture'' part of the model space,
\[
  W_m^{-1}N \approx I +\alpha^2 W_m^{-1}A^TW_mA
\]
For small $\alpha$, this operator is a perturbation of the spectrum of the identity, so convergence should be rapid. 

In the preceding section, I showed that effective choices for the weight operators are $W_m = \Lambda_s^{-1}$ and $W_d = \Lambda_r$, which are resepctively the ``Neumann-to-Dirichlet'' operator mapping pressure to normal particle velocity on the source surface $\{z=z_s\}$, and the ``Dirichlet-to-Neumann'' operator mapping pressure to normal particle velocity on the receiver surface. Application of these operators are expensive and/or awkward, so should be avoided if at all possible. 

A very important point: the weighted ``partial'' adjoint $S^*=S^TW_d$ appears {\em only} in combination with $S$ in the algorithm listed above, {\em except} for the very first line. That is, one can calculate $W_dS$ followed by $S^T$, rather than $S$ followed by $S^TW_d$, provided that you can take care of the first line. $W_dS$ For any variant of elasticity, $W_d$ relates two combinations of dynamical field components - for acoustics, it returns the normal velocity for a given pressure field on the receiver surface. In the solution of the dynamical equations (for instance \ref{eqn:awe}), all components are calculated. Therefore obtaining the output of $W_d$ amounts to extracting the appropriate field combination. For acoustics, simply record the normal velocity rather than the pressure: then you have computed $W_dS$. Therefore no additional expensive computations are required. It is only the very first instance of $S^*$, on the first line, where an actual computation of $W_d$ is required, unless cheap workarounds like that explained by \cite{HouSymes:15} are available.

\section{Prototype Numerical Examples}
I present a collection of simple examples that illustrate the features of the surface source extension claimed in preceding sections. 

I used the IWAVE acoustic staggered grid package to carry out these calculations. This package implements (2,2k) schemes for k=1,2,..., and outputs traces (of either velocity or pressure at any point in space via multilinear interpolation. The discretized modeling operator is thus of second order accuracy, though as usual I have used higher order in space to reduce grid dispersion.

Source injection is implemented as the adjoint of trace sampling, resulting in another second-order error [REFERENCES]. 

The data is a single shot gather, with a source at coordinates $x_s=z_s=3000$ m (units of length are meters in all cases). The receiver line occupies $1500 \le x_r \le 5500$ m, with receiver depth $z_r=1000$ m.  Extended sources occupy $1500 \le x_s \le 5500$ m, with the same depth $z_s=3000$ m as the ``physical'' source used to generate the data. This region turns out to be adequate to represent the extended sources that approximately invert the data, for the cases examined below. An algorithm to automatically identify an appropriate region can be based on the ideas developed by \cite{Fu:Geo17}.

I have used absorbing boundary conditions (split-field PML) on all four sides of the 4000 m (vertical) $\times$ 8000 m (horizontal) simulation domain. Evidently inclusion of a free surface is important to the application of the ideas explained here to diving wave marine data, and I have not addressed the necessary modifications here. 

The Dirichlet-to-Neumann operator $\Lambda$ is an essential part of the inner problem preconditioner just presented. Implementation can be accomplished in several ways:
\begin{itemize}
\item \cite{tenKroode:12} suggests using a one-way operator;
\item if both pressure and normal partical velocity are measured (or simulated), then the two are related by $\Lambda$ and the velocity component can simply be used as the output;
\item presence of a free surface implies all of the usual problems, such as the need for removal of receiver-side ghosts. On the other hand, if the free surface is within a quarter-wavelength throughout the useful bandwidth of the data, then the ghosted data differs from $\Lambda p$ by a time integration and a scale factor, a fact used to good effect by \cite{HouSymes:15}.
\end{itemize}

In the examples, I have used the second observation. With a finite difference implementation of the pressure-velocity system \ref{eqn:awe}, velocity components are available ``for free'', short-circuiting explicit computation of $\Lambda$.

The  {\tt project/SConstruct} script is set up to carry out the necessary computations on grids with spacings $\Delta x = \Delta z = $ 20, 10, and 5 m, with a jump of roughly 8 in computation time resulting from each refinement. For present purposes, the coarsest (20 m) grid seems to be sufficient, and that is the grid used in the examples presented below. The source pulses are chosen so that the computation is reasonably accurate. For the 20 m grid case, I use a zero-phase trapezoidal bandpass filter source with corner frequencies of 1.0, 2.0, 7.5, and 12.5 Hz.

The IWAVE asg driver has been set up to recognize the case {\tt deriv=0} as defining the map from source (right-hand side in the pressure equation) to data (pressure) traces. The adjoint to this map, as explained above, is reverse-time propagation of the data traces as pressure sources, followed by scaling (formula \ref{eqn:sadj}). The approximate inverse is computed by application of the Dirichlet-to-Neumann operator to the pressure traces to produce corresponding velocity traces, followed by injection as pressure sources and reverse time propagation, followed by another application of the Dirichlet-to-Neumann map and scaling (formulas \ref{eqn:appinv}, \ref{eqn:adj}).

The script implements these operatations step-by-step via calls to IWAVE, Madagascar, and SU commands. A peculiarity of the {\tt asg.x} driver needs to be mentioned: it is based on an un-scaled version of the constitutive law defect source representation, that is, {\tt asg.x} approximately computes the solution of the system \ref{eqn:awedata} with the first equation replaced by
\begin{equation}
\label{eqn:asgdata}
\frac{\partial p}{\partial t}  =  - \kappa \nabla \cdot \bv +
h \delta(z-z_s).
\end{equation}
Denote by $S_{\rm asg}[c]$ the forward map produced by {\tt asg.x}. Then comparison of \ref{eqn:awedata} and \ref{eqn:asgdata} reveals that
\begin{equation}
\label{eqn:sreln}
S[c]=S_{\rm asg}[c]\kappa
\end{equation}
where $\kappa$ is shorthand for the operator of multiplication by $\kappa$. Accordingly, and approximate inverse for $S_{\rm asg}[c]$ is
\[
I \approx S_{\rm asg}[c]^{\dagger}S_{\rm asg}[c] = S_{\rm asg}[c]^{\dagger}S[c]\kappa^{-1}
\]
Since $S[c]S[c]^{\dagger} \approx I \approx S[c]^{\dagger}S[c]$, it follows that
\[
S_{\rm asg}[c]^{\dagger}=\kappa S[c]^{\dagger} = \kappa\Lambda[c]_s S[c]^T \Lambda[c]_r 
\]
\begin{equation}
\label{eqn:asginv}
= \kappa \Lambda[c]_s \kappa S_{\rm asg}[c]^T\Lambda[c]_r
\end{equation}
This is the approximate inverse computed in the examples. Note that only the values of $\kappa$ near the source datum $z=z_s$ play a role in the relation \ref{eqn:sreln} or in the definition \ref{eqn:asginv} of the IWAVE ASG approximate inverse.
\bibliographystyle{seg}
\bibliography{../../bib/masterref}


\bibliographystyle{seg}
\bibliography{../../bib/masterref}
